import Ig from"node:http";import lg from"node:https";import{WebSocket as sg,WebSocketServer as cg}from"ws";import{WebSocket as og}from"ws";var k="server",J="client",Q="webclient",V="browser";var v=class{constructor(I,g){this.originName=I,this.message=g}},b=!1;function ig(){let C=Date.now().toString(16),I=(1e6*Math.random()|0).toString(16);return`${C}-${I}`}var F=":response",H=C=>`${C}${F}`,f=Symbol("origin"),U=Symbol("proxy"),X=Symbol("receiver"),y=Symbol("remote"),N=Symbol("handlers"),L=class C extends og{[f]=void 0;[U]=void 0;[X]="";[y]="";[N]={};constructor(){throw new Error("Cannot create UpgradedSocket instances. Use UpgradedSocket.upgrade(name, origin, socket) instead.")}static upgrade(I,g,l,c){if(I instanceof C)return I;Object.setPrototypeOf(I,C.prototype),I[f]=g,I[X]=l,I[y]=c,I[N]={};let o=I.router.bind(I);return I.on?I.on("message",o):I.onmessage=o,I}get upgraded(){return this.__upgraded||(this.__upgraded={on:(...I)=>this.__on(...I),off:(...I)=>this.__off(...I),send:(...I)=>this.__send(...I)}),this.__upgraded}async router(I,g=!1){let{[f]:l,[X]:c,[y]:o}=this;if(o===V&&!g)return;I.srcElement&&(I=I.data);let d;try{d=JSON.parse(I)}catch{return console.error(`Could not parse websocket data: ${I}`)}let{name:n,payload:i,error:e,diff:s,seq_num:Z}=d,{state:t}=d,G=e?new v(c,e):void 0;if(b&&console.log(`[${c}]/[${o}] router running given:`,{eventName:n,payload:i,errorMsg:e,state:t,diff:s,seq_num:Z}),t&&c===V){b&&console.log("handling state update in the browser",t),b&&console.log("origin object:",{origin:l});let B=JSON.parse(JSON.stringify(l.state));if(s){b&&console.log("received diff",t);let S=t,K;if(Z===l.__seq_num+1)l.__seq_num=Z,K=JSON.parse(JSON.stringify(B)),b&&console.log("applying patch to",K),rfc6902.applyPatch(K,S);else{b&&console.log("seq_num mismatch, syncing state");let Cg=await this.__send("syncState");l.__seq_num=0,K=Cg}t=K}return l.state=t,l.update?.(B)}if(n.endsWith(F)){let{[N]:B}=this;if(b&&console.log(`[${c}] response message received`),!B[n])throw new Error(`no handlers for ${n}`);B[n].forEach(S=>{S(G||i)});return}if(i&&!Array.isArray(i))throw new Error(`[${c}] received payload for ${n} from [${o}] but it was not an array? ${JSON.stringify(i,null,2)}`);let m=n.split(":");b&&console.log(`[${c}] router: stages:`,m);let a=l,[A]=m,p=l.__proto__?.constructor.disallowedCalls??[],r,u;if(A&&p.includes(A)&&(r=`Illegal call: ${A} is a protected property`),!r)try{for(;m.length;){let B=m.shift();b&&console.log(`checking ${B}`),a=a[B]}c==="server"&&i.unshift(this[U])}catch(B){b&&console.error(`cannot resolve ${n} on ${c}`,B),r=B.message}if(!r)try{u=await a.bind(l)(...i)??!0,c===J&&l.browser&&l.setState(l.state)}catch(B){b&&console.error(`function invocation for ${n} failed on ${c}, payload:`,i),b&&console.error(B),r=`Cannot call [[${c}]].${n.replaceAll(":",".")}, function is not defined.`}let Y=H(n);b&&console.log(`[${c}] sending ${Y}`,{payload:u,error:r}),super.send(JSON.stringify({name:Y,payload:u,error:r}))}__on(I,g){let{[N]:l}=this;return l[I]||(l[I]=[]),l[I].push(g),()=>this.__off(I,g)}__off(I,g){let{[N]:l}=this;if(!l[I])return;let c=l[I].indexOf(g);l[I].splice(c,1)}async __send(I,g={},l=1e3){let{[X]:c,[y]:o}=this;return b&&console.log(`[${c}] sending [${I}] to [${o}]:`,g),await new Promise((d,n)=>{let i=H(I),e=(t=void 0)=>{b&&console.log(`[${c}] cleanup`),this.__off(i,s),e=()=>{},d(t)},s=t=>e(t);this.__on(i,t=>{b&&console.log(`[${c}] handling response for ${I} from [${o}]:`),s(t)});let Z=()=>{b&&console.log(`(raw) sending ${I} from ${c} to ${o}`),super.send(JSON.stringify({name:I,payload:g}))};super.readyState===1?Z():super.onopen=Z,isFinite(l)&&setTimeout(()=>e(),l)})}},z=class C extends Function{constructor(I,g,l,c=""){return super(),this[X]=g,this[y]=l,this.id=ig(),this.path=c,this.socket=I,new Proxy(this,{get:(o,d)=>d==="id"?this.id:d==="socket"?this.socket:new C(I,g,l,`${c}:${d}`),apply:async(o,d,n)=>{b&&console.log(`[SPapply] sending ${this.path.substring(1)} receiver ${this[X]} to ${this[y]}`);let i=await this.socket.upgraded.send(this.path.substring(1),n,this[y]===V?1/0:void 0);if(i instanceof v){let e=[...new Array(n.length)].map((s,Z)=>String.fromCharCode(97+Z)).join(",");throw b&&console.error(`ERROR calling [[${i.originName}]].${this.path.substring(1).replaceAll(":",".")}(${e}): ${i.message}`),new Error(i.message)}return i}})}};function R(C,I,g,l){return l=L.upgrade(l,g,C,I),l[U]=new z(l,C,I)}var h=!1,x=Symbol();function j(C){return class T extends C{static get disallowedCalls(){let g=Object.getOwnPropertyNames(T.prototype);return["constructor","disconnect"].forEach(l=>g.splice(g.indexOf(l),1)),g.push("server","state"),g}constructor(){super();let g=this[x]={},l=new Proxy(g,{get:(c,o)=>g[o],set:()=>{throw new Error("cannot directly assign to state, use setState(update)")}});Object.defineProperty(this,"state",{value:l,writable:!1,configurable:!1})}onConnect(){super.onConnect?.(),h&&console.log(`[ClientBase] client ${this.state.id} connected.`)}onDisconnect(){super.onDisconnect?.(),h&&console.log(`[ClientBase] client ${this.state.id} disconnected.`)}setState(g){h&&console.log("[ClientBase] updating state");let l=this[x];Object.entries(g).forEach(([c,o])=>l[c]=o)}connectServerSocket(g){h&&console.log("[ClientBase]  connected to server"),this.server=R(J,k,this,g),this.onConnect()}disconnect(){this.server.socket.close()}}}function O(C){return class E extends C{clients=[];ws=void 0;webserver=void 0;static get disallowedCalls(){let g=Object.getOwnPropertyNames(E.prototype);return g.splice(g.indexOf("constructor"),1),g.push("clients","ws","webserver"),g}constructor(g,l){super(),this.ws=g,this.webserver=l}async connectClientSocket(g){h&&console.log("[ServerBase] client connecting to server...");let l=R(k,J,this,g);h&&console.log("[ServerBase] sending connection id"),l.socket.send(JSON.stringify({name:"handshake:setid",payload:{id:l.id}})),h&&console.log("[ServerBase] adding client to list of known clients"),this.clients.push(l),this.addDisconnectHandling(l,g),this.onConnect(l)}async addDisconnectHandling(g,l){let{clients:c}=this;l.on("close",()=>{let o=c.findIndex(d=>d===g);if(o!==-1){let d=c.splice(o,1)[0];this.onDisconnect(g)}})}async onDisconnect(g){super.onDisconnect?.(g),h&&console.log(`[ServerBase] client ${g.id} disconnected.`)}async onConnect(g){super.onConnect?.(g),h&&console.log(`[ServerBase] client ${g.id} connected.`)}async quit(){await this.onQuit(),this.clients.forEach(g=>g.disconnect()),this.ws.close(),this.webserver.closeAllConnections(),this.webserver.close(()=>this.teardown())}async onQuit(){super.onQuit?.(),h&&console.log("[ServerBase] told to quit.")}async teardown(){super.teardown?.(),h&&console.log("[ServerBase] post-quit teardown.")}}}import{createPatch as eg}from"rfc6902";var W=!1;function M(C){return class P extends C{browser=void 0;static get disallowedCalls(){let g=Object.getOwnPropertyNames(P.prototype).concat(C.disallowedCalls);return["constructor","quit","syncState"].forEach(l=>g.splice(g.indexOf(l),1)),g.push("browser","ws","webserver"),g}constructor(){super(),this.onBrowserConnect||(this.onBrowserConnect=async g=>{W&&console.log("[WebClientBase] browser connected.")}),this.onBrowserDisconnect||(this.onBrowserDisconnect=async g=>{W&&console.log("[WebClientBase] browser disconnected.")})}connectBrowserSocket(g){this.browser||(this.browser=R(Q,V,this,g),this.browser.socket.__seq_num=0,this.setState(this.state),this.onBrowserConnect(this.browser))}disconnectBrowserSocket(){this.onBrowserDisconnect(this.browser),this.browser=void 0}setState(g){if(W&&console.log("[WebClientBase] setState"),super.setState(g),W&&console.log("[WebClientBase] client has browser?",!!this.browser),this.browser){W&&console.log("[WebClientBase] creating diff as part of setState");let l=eg(this.__oldState??{},this.state);if(l.length>0){let c={state:l,seq_num:++this.browser.socket.__seq_num,diff:!0};W&&console.log("[WebClientBase] sending diff as part of setState:",c),this.browser.socket.send(JSON.stringify(c))}else W&&console.log("no difference, skipping state sync.")}this.__oldState=JSON.parse(JSON.stringify(this.state))}syncState(){if(this.browser){W&&console.log("[WebClientBase] running syncState (will respond with full state)");let g=JSON.parse(JSON.stringify(this.state));return this.browser.socket.__seq_num=0,W&&console.log("[WebClientBase] responding with full state:",g),g}throw new Error("[WebClientBase] Cannot sync state: no browser attached to client.")}async quit(){this.browser&&(this.browser.socket.close(),this.disconnectBrowserSocket()),this.disconnect(),await this.onQuit(),this.ws.close(),this.webserver.closeAllConnections(),this.webserver.close(()=>this.teardown())}async onQuit(){super.onQuit?.(),W&&console.log(`[WebClient] client ${this.id} told to quit.`)}async teardown(){super.teardown?.(),W&&console.log(`[WebClient] client ${this.id} running teardown.`)}}}var w=class{constructor(I){this.owner=I,this.routes={}}addRouteHandler(I,...g){this.routes[I]=g}removeRoute(I){delete this.routes[I]}async handle(I,g,l){let c=this.routes[I];if(!c)return!1;for(let o=0,d=c.length;o<d;o++){let n=c[o],i=!0,e=()=>i=!1;try{await n(g,l,e)}catch(s){console.error(s),console.trace();break}if(i)break}return!0}};import ng from"node:fs";import{join as _}from"node:path";var D=atob("LyoqCiAqIFRoaXMgZmlsZSBob3VzZXMgdGhlIGNvcmUgb2YgdGhlIFJQQyBmdW5jdGlvbmFsaXR5LgogKgogKiBUaGUgYFVwZ3JhZGVkU29ja2V0YCBjbGFzcyBpcyBhbiBleHRlbnNpb24gb24gdGhlIFdlYlNvY2tldCBjbGFzcyB0aGF0IGFkZHMKICogY3VzdG9tIG9uL29mZi9zZW5kIG1ldGhvZHMgKGV4cG9zZWQgdGhyb3VnaCBhIHNvY2tldC51cGdyYWRlZCBvYmplY3QpLCBzZXQKICogdXAgdG8gaGFuZGxlIGF1dG9tYXRpYyByZXNwb25zZXMgdG8gY2FsbHMuIEluY29taW5nIFdlYlNvY2tldCBtZXNzYWdlcyBhcmUKICogcm91dGVkIGludG8gdGhlIGByb3V0ZXJgIGZ1bmN0aW9uLCB3aGljaCBoYXMgYmVoYXZpb3VyIHRhaWxvcmVkIHRvIHNwZWNpZmljCiAqIG9yaWdpbnMsIGFuZCBtYWtlcyBzdXJlIHRoYXQgbWVzc2FnZXMgYXJlIGFsd2F5cyByZXNwb25kZWQgdG8uCiAqCiAqIFRoZSBgX19zZW5kYCBmdW5jdGlvbiwgaW4gdHVybiwgZG9lc24ndCBqdXN0IHNlbmQgZGF0YSBvdmVyIHRvIGEgcmVtb3RlLCBidXQKICogYWxzbyB3YWl0cyBmb3IgdGhhdCByZW1vdGUncyA6cmVzcG9uc2UgbWVzc2FnZSwgdXNpbmcgUHJvbWlzZXMgdG8gbWFrZQogKiBzdXJlIHRoYXQgYW55b25lIGNhbiBgYXdhaXQgc29ja2V0LnVwZ3JhZGVkLnNlbmQoLi4uKWAgYW5kIGdldCBhIHJlc3BvbnNlCiAqIG9uY2UgdGhhdCByZXNwb25zZSBoYXMgYmVlbiBzZW50IGJhY2suIEFzIGZhciBhcyBjYWxsaW5nIGNvZGUgaXMgY29uY2VybmVkLAogKiB0aGlzIGlzIGEgbm9ybWFsIGFzeW5jIGNhbGwsIGFuZCB0aGUgZmFjdCB0aGF0IG5ldHdvcmsgdHJhbnNwb3J0IGhhcHBlbmVkCiAqIGlzIGVudGlyZWx5IGlycmVsZXZhbnQuIENhbGxlcnMgc2hvdWxkIG5vdCBjYXJlLgogKgogKiBUaGUgYFNvY2tldFByb3h5YCBpcyBhIGNsZXZlciBsaXR0bGUgUHJveHkgb2JqZWN0IHRoYXQgZXh0ZW5kcyB0aGUgRnVuY3Rpb24KICogYnVpbHQtaW4sIHdoaWNoIGFsbG93cyB1cyB0byBjcmVhdGUgYSByZWN1cnNpdmUgb2JqZWN0IHdoZXJlIGFueSBwcm9wZXJ0eQogKiBvbiBpdCBpcyBhIHZhbGlkIGZ1bmN0aW9uIHRvIGNhbGwsIGFuZCBkb2luZyBzbyB3aWxsIHNlbmQgdGhlIGNvcnJlc3BvbmRpbmcKICogY2FsbCBjaGFpbiBvdmVyIHRvIHRoZSByZW1vdGUgZm9yIGV4ZWN1dGlvbiBhbmQgcmVzcG9uc2UgbWVzc2FnaW5nLiBUaGlzIHdheSwKICogd2UgZG9uJ3QgbmVlZCB0byBwZXJmb3JtIGFueSAid2hpY2ggZnVuY3Rpb25zIGFyZSBzdXBwb3J0ZWQiLCB3ZSBjYW4ganVzdCBwcm94eQogKiB0aGUgY2FsbCBvdmVyIHRoZSBuZXR3b3JrLCBpZiBpdCBleGlzdHMsIGl0IHJ1bnMsIGlmIGl0IGRvZXNuJ3QsIHRoZW4gd2UnbGwKICogZ2V0IGEgcmVzdWx0IGJhY2sgd2l0aCBhbiBgZXJyb3JgIG1lc3NhZ2UgdGhhdCB3ZSBjYW4gdHVybiBpbnRvIGEgbG9jYWwgdGhyb3cuCiAqLwoKCmNvbnN0IEJST1dTRVIgPSAiYnJvd3NlciI7CmNvbnN0IENMSUVOVCA9ICJjbGllbnQiOwoKY2xhc3MgUlBDRXJyb3IgewogIGNvbnN0cnVjdG9yKG9yaWdpbk5hbWUsIG1lc3NhZ2UpIHsKICAgIHRoaXMub3JpZ2luTmFtZSA9IG9yaWdpbk5hbWU7CiAgICB0aGlzLm1lc3NhZ2UgPSBtZXNzYWdlOwogIH0KfQoKY29uc3QgREVCVUcgPSBmYWxzZTsKCi8vIGltcG9ydGluZyB0aGUgdXVpZCBwYWNrYWdlIGlzIHdheSB0b28gZXhwZW5zaXZlIGZvciB3aGF0IHdlIG5lZWQgaGVyZQpmdW5jdGlvbiB1dWlkKCkgewogIGNvbnN0IG5vdyA9IERhdGUubm93KCkudG9TdHJpbmcoMTYpOwogIGNvbnN0IHJkbSA9ICgoMWU2ICogTWF0aC5yYW5kb20oKSkgfCAwKS50b1N0cmluZygxNik7CiAgcmV0dXJuIGAke25vd30tJHtyZG19YDsKfQoKLy8gcmVzcG9uc2VzIHNob3VsZCBhbHdheXMgYmUgInRoZSBldmVudCBuYW1lLCB3aXRoIDpyZXNwb25zZSBhZGRlZCIKZXhwb3J0IGNvbnN0IFJFU1BPTlNFX1NVRkZJWCA9IGA6cmVzcG9uc2VgOwpleHBvcnQgY29uc3QgZ2V0UmVzcG9uc2VOYW1lID0gKGV2ZW50TmFtZSkgPT4gYCR7ZXZlbnROYW1lfSR7UkVTUE9OU0VfU1VGRklYfWA7CgovLyB1c2Ugc3ltYm9scyBzbyB3ZSBkb24ndCBwb2xsdXRlIHRoZSBzb2NrZXQgcHJvdG90eXBlCmNvbnN0IE9SSUdJTiA9IFN5bWJvbChgb3JpZ2luYCk7CmNvbnN0IFBST1hZID0gU3ltYm9sKGBwcm94eWApOwpjb25zdCBSRUNFSVZFUiA9IFN5bWJvbChgcmVjZWl2ZXJgKTsKY29uc3QgUkVNT1RFID0gU3ltYm9sKGByZW1vdGVgKTsKY29uc3QgSEFORExFUlMgPSBTeW1ib2woYGhhbmRsZXJzYCk7CgovKioKICogLi4uZG8gZG9jcyBnbyBoZXJlPwogKi8KY2xhc3MgVXBncmFkZWRTb2NrZXQgZXh0ZW5kcyBXZWJTb2NrZXQgewogIFtPUklHSU5dID0gdW5kZWZpbmVkOyAvLyB0aGUgc29ja2V0IG93bmVyIHdobyBpbnZva2VkIHRoZSB1cGdyYWRlLiBTZWUgdXBncmFkZSgpCiAgW1BST1hZXSA9IHVuZGVmaW5lZDsgLy8gdGhlIHByb3h5IG9iamVjdCBhc3NvY2lhdGVkIHdpdGggdGhpcyBzb2NrZXQKICBbUkVDRUlWRVJdID0gYGA7IC8vIG5hbWUgb2YgdGhlIHJlY2VpdmluZyBvYmplY3QKICBbUkVNT1RFXSA9IGBgOyAvLyBuYW1lIG9mIHRoZSByZW1vdGUgb2JqZWN0CiAgW0hBTkRMRVJTXSA9IHt9OyAvLyB0aGUgbGlzdCBvZiBldmVudCBoYW5kbGVycy4gU2VlIHVwZ3JhZGUoKQoKICAvLyBleHBsaWNpdGx5IGZvcmJpZCB0aGUgY29uc3RydWN0b3IgZnJvbSBiZWluZyB1c2VkLgogIC8vIEB0cy1pZ25vcmU6IHdlIGRvbid0IG5lZWQgdG8gY2FsbCBzdXBlcigpIGlmIHdlIGVycm9yIG91dC4KICBjb25zdHJ1Y3RvcigpIHsKICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgIkNhbm5vdCBjcmVhdGUgVXBncmFkZWRTb2NrZXQgaW5zdGFuY2VzLiBVc2UgVXBncmFkZWRTb2NrZXQudXBncmFkZShuYW1lLCBvcmlnaW4sIHNvY2tldCkgaW5zdGVhZC4iLAogICAgKTsKICB9CgogIC8vIHVwZ3JhZGUgYSBzb2NrZXQgZnJvbSBwbGFpbiBXZWJTb2NrZXQgdG8gdGhpcyBjbGFzcyBpbnN0ZWFkLgogIHN0YXRpYyB1cGdyYWRlKHNvY2tldCwgb3JpZ2luLCByZWNlaXZlciwgcmVtb3RlKSB7CiAgICBpZiAoc29ja2V0IGluc3RhbmNlb2YgVXBncmFkZWRTb2NrZXQpIHJldHVybiBzb2NrZXQ7CiAgICAvLyB1cGRhdGUgdGhlIHByb3RvdHlwZSBiaW5kaW5nCiAgICBPYmplY3Quc2V0UHJvdG90eXBlT2Yoc29ja2V0LCBVcGdyYWRlZFNvY2tldC5wcm90b3R5cGUpOwogICAgLy8gbWFrZSBzdXJlIHRoYXQgbWVzc2FnZXMgZ28gdGhyb3VnaCB0aGUgcm91dGVyOgogICAgc29ja2V0W09SSUdJTl0gPSBvcmlnaW47CiAgICBzb2NrZXRbUkVDRUlWRVJdID0gcmVjZWl2ZXI7CiAgICBzb2NrZXRbUkVNT1RFXSA9IHJlbW90ZTsKICAgIHNvY2tldFtIQU5ETEVSU10gPSB7fTsKICAgIGNvbnN0IG1lc3NhZ2VSb3V0ZXIgPSBzb2NrZXQucm91dGVyLmJpbmQoc29ja2V0KTsKICAgIGlmIChzb2NrZXQub24pIHsKICAgICAgc29ja2V0Lm9uKGBtZXNzYWdlYCwgbWVzc2FnZVJvdXRlcik7CiAgICB9IGVsc2UgewogICAgICBzb2NrZXQub25tZXNzYWdlID0gbWVzc2FnZVJvdXRlcjsKICAgIH0KCiAgICAvLyBjb252ZW5pZW5jZSByZXR1cm4uCiAgICByZXR1cm4gc29ja2V0OwogIH0KCiAgLy8gU3BlY2lhbCBhY2Nlc3NvciBmb3IgdXBncmFkZWQgc29ja2V0IGZ1bmN0aW9ucywKICBnZXQgdXBncmFkZWQoKSB7CiAgICBpZiAoIXRoaXMuX191cGdyYWRlZCkgewogICAgICB0aGlzLl9fdXBncmFkZWQgPSB7CiAgICAgICAgb246ICguLi5hcmdzKSA9PiB0aGlzLl9fb24oLi4uYXJncyksCiAgICAgICAgb2ZmOiAoLi4uYXJncykgPT4gdGhpcy5fX29mZiguLi5hcmdzKSwKICAgICAgICBzZW5kOiAoLi4uYXJncykgPT4gdGhpcy5fX3NlbmQoLi4uYXJncyksCiAgICAgIH07CiAgICB9CiAgICByZXR1cm4gdGhpcy5fX3VwZ3JhZGVkOwogIH0KCiAgLy8gbWVzc2FnZSByb3V0ZXIgc3BlY2lmaWNhbGx5IGZvciB0aGUgbWVzc2FnZSBmb3JtYXQgdXNlZCBieSB0aGUgc29ja2V0bGVzcyBjb2RlLgogIGFzeW5jIHJvdXRlcihtZXNzYWdlLCBmb3JjZWQgPSBmYWxzZSkgewogICAgY29uc3QgeyBbT1JJR0lOXTogb3JpZ2luLCBbUkVDRUlWRVJdOiByZWNlaXZlciwgW1JFTU9URV06IHJlbW90ZSB9ID0gdGhpczsKCiAgICAvLyBBbnkgY2FsbHMgZnJvbSB0aGUgYnJvd3NlciB0byB0aGUgd2ViY2xpZW50IGFyZSB0aGF0J3MgYWxyZWFkeSBoYW5kbGVkCiAgICAvLyBieSB0aGUgd2Vic29ja2V0IGRpcmVjdGx5IChzZWUgdGhlIGNyZWF0ZVdlYkNsaWVudCBmdW5jdGlvbiBpbiBpbmRleC5qcywKICAgIC8vIGluIHRoZSB3cy5vbihgY29ubmVjdGlvbmAsIC4uLikgYmxvY2spLCBzbyB3ZSBuZWVkIHRvIG1ha2Ugc3VyZSB0byBub3QKICAgIC8vIHRyeSB0byAiZG91YmxlLWhhbmRsZSIgdGhhdDoKICAgIGlmIChyZW1vdGUgPT09IEJST1dTRVIgJiYgIWZvcmNlZCkgewogICAgICByZXR1cm47CiAgICB9CgogICAgLy8gYnJvd3NlciB3ZWJzb2NrZXQ/IElmIHNvLCB1bndyYXAgdGhlIGRhdGEKICAgIGlmIChtZXNzYWdlLnNyY0VsZW1lbnQpIHsKICAgICAgbWVzc2FnZSA9IG1lc3NhZ2UuZGF0YTsKICAgIH0KCiAgICBsZXQgZGF0YTsKCiAgICB0cnkgewogICAgICBkYXRhID0gSlNPTi5wYXJzZShtZXNzYWdlKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgcmV0dXJuIGNvbnNvbGUuZXJyb3IoYENvdWxkIG5vdCBwYXJzZSB3ZWJzb2NrZXQgZGF0YTogJHttZXNzYWdlfWApOwogICAgfQoKICAgIGNvbnN0IHsgbmFtZTogZXZlbnROYW1lLCBwYXlsb2FkLCBlcnJvcjogZXJyb3JNc2csIGRpZmYsIHNlcV9udW0gfSA9IGRhdGE7CiAgICBsZXQgeyBzdGF0ZSB9ID0gZGF0YTsKICAgIGxldCB0aHJvd2FibGUgPSBlcnJvck1zZyA/IG5ldyBSUENFcnJvcihyZWNlaXZlciwgZXJyb3JNc2cpIDogdW5kZWZpbmVkOwoKICAgIGlmIChERUJVRykKICAgICAgY29uc29sZS5sb2coYFske3JlY2VpdmVyfV0vWyR7cmVtb3RlfV0gcm91dGVyIHJ1bm5pbmcgZ2l2ZW46YCwgewogICAgICAgIGV2ZW50TmFtZSwKICAgICAgICBwYXlsb2FkLAogICAgICAgIGVycm9yTXNnLAogICAgICAgIHN0YXRlLAogICAgICAgIGRpZmYsCiAgICAgICAgc2VxX251bSwKICAgICAgfSk7CgogICAgLy8gQ2xpZW50LXN0YXRlIHN5bmNocm9uaXphdGlvbiBtZWNoYW5pc20gZm9yIHRoZSBicm93c2VyOgogICAgaWYgKHN0YXRlICYmIHJlY2VpdmVyID09PSBCUk9XU0VSKSB7CiAgICAgIGlmIChERUJVRykgY29uc29sZS5sb2coYGhhbmRsaW5nIHN0YXRlIHVwZGF0ZSBpbiB0aGUgYnJvd3NlcmAsIHN0YXRlKTsKICAgICAgaWYgKERFQlVHKSBjb25zb2xlLmxvZyhgb3JpZ2luIG9iamVjdDpgLCB7IG9yaWdpbiB9KTsKICAgICAgY29uc3QgcHJldlN0YXRlID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShvcmlnaW4uc3RhdGUpKTsKICAgICAgaWYgKGRpZmYpIHsKICAgICAgICBpZiAoREVCVUcpIGNvbnNvbGUubG9nKGByZWNlaXZlZCBkaWZmYCwgc3RhdGUpOwogICAgICAgIGNvbnN0IHBhdGNoID0gc3RhdGU7CiAgICAgICAgbGV0IHRhcmdldDsKICAgICAgICAvLyB2ZXJpZnkgd2UncmUgc3RpbGwgaW4gc3luYyBieSBjb21wYXJpbmcgbWVzc2FnaW5nIHNlcXVlbmNlIG51bWJlcnMKICAgICAgICBpZiAoc2VxX251bSA9PT0gb3JpZ2luLl9fc2VxX251bSArIDEpIHsKICAgICAgICAgIG9yaWdpbi5fX3NlcV9udW0gPSBzZXFfbnVtOwogICAgICAgICAgdGFyZ2V0ID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShwcmV2U3RhdGUpKTsKICAgICAgICAgIGlmIChERUJVRykgY29uc29sZS5sb2coYGFwcGx5aW5nIHBhdGNoIHRvYCwgdGFyZ2V0KTsKICAgICAgICAgIC8vIEB0cy1pZ25vcmU6IHRoaXMgb25seSBydW5zIGluIHRoZSBicm93c2VyLCB3aGVyZSByZmM2OTAyIGlzIGEgZ2xvYmFsLgogICAgICAgICAgcmZjNjkwMi5hcHBseVBhdGNoKHRhcmdldCwgcGF0Y2gpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBpZiB3ZSBnZXQgaGVyZSwgd2UncmUgbm90IGluIHN5bmMsIGFuZCB3ZSBuZWVkIHRvIHJlcXVlc3QgYSBmdWxsCiAgICAgICAgICAvLyBzdGF0ZSBvYmplY3QgaW5zdGVhZCBvZiB0cnlpbmcgdG8gYXBwbHkgZGlmZmVyZW50aWFsIHVwZGF0ZXMuCiAgICAgICAgICBpZiAoREVCVUcpIGNvbnNvbGUubG9nKGBzZXFfbnVtIG1pc21hdGNoLCBzeW5jaW5nIHN0YXRlYCk7CiAgICAgICAgICBjb25zdCBmdWxsU3RhdGUgPSBhd2FpdCB0aGlzLl9fc2VuZChgc3luY1N0YXRlYCk7CiAgICAgICAgICBvcmlnaW4uX19zZXFfbnVtID0gMDsKICAgICAgICAgIHRhcmdldCA9IGZ1bGxTdGF0ZTsKICAgICAgICB9CiAgICAgICAgc3RhdGUgPSB0YXJnZXQ7CiAgICAgIH0KICAgICAgLy8gUnVuIHRoZSB1cGRhdGUgd2l0aCB0aGUgbmV3IHN0YXRlIGFzIGFyZ3VtZW50IGZpcnN0LCB0aGVuCiAgICAgIC8vIG92ZXJ3cml0ZSB0aGUgb2xkIHN0YXRlIHdpdGggdGhlIG5ldyBzdGF0ZSBhZnRlciB0aGUgdXBkYXRlLgogICAgICBvcmlnaW4uc3RhdGUgPSBzdGF0ZTsKICAgICAgcmV0dXJuIG9yaWdpbi51cGRhdGU/LihwcmV2U3RhdGUpOwogICAgfQoKICAgIC8vIElmIHRoaXMgaXMgYSByZXNwb25zZSBtZXNzYWdlLCBydW4gdGhlIGBvbmAgaGFuZGxlciBmb3IgdGhhdC4KICAgIGlmIChldmVudE5hbWUuZW5kc1dpdGgoUkVTUE9OU0VfU1VGRklYKSkgewogICAgICBjb25zdCB7IFtIQU5ETEVSU106IGhhbmRsZXJzIH0gPSB0aGlzOwogICAgICBpZiAoREVCVUcpIGNvbnNvbGUubG9nKGBbJHtyZWNlaXZlcn1dIHJlc3BvbnNlIG1lc3NhZ2UgcmVjZWl2ZWRgKTsKICAgICAgaWYgKCFoYW5kbGVyc1tldmVudE5hbWVdKSB0aHJvdyBuZXcgRXJyb3IoYG5vIGhhbmRsZXJzIGZvciAke2V2ZW50TmFtZX1gKTsKICAgICAgaGFuZGxlcnNbZXZlbnROYW1lXS5mb3JFYWNoKChoYW5kbGVyKSA9PiB7CiAgICAgICAgaGFuZGxlcih0aHJvd2FibGUgPyB0aHJvd2FibGUgOiBwYXlsb2FkKTsKICAgICAgfSk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBJZiB3ZSBnZXQgaGVyZSwgdGhpcyBpcyBhIHJlYWwgUlBDIGNhbGwgcmF0aGVyIHRoYW4gYSByZXNwb25zZSBvciBzdGF0ZSB1cGRhdGUuCiAgICBpZiAocGF5bG9hZCAmJiAhQXJyYXkuaXNBcnJheShwYXlsb2FkKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgYFske3JlY2VpdmVyfV0gcmVjZWl2ZWQgcGF5bG9hZCBmb3IgJHtldmVudE5hbWV9IGZyb20gWyR7cmVtb3RlfV0gYnV0IGl0IHdhcyBub3QgYW4gYXJyYXk/ICR7SlNPTi5zdHJpbmdpZnkoCiAgICAgICAgICBwYXlsb2FkLAogICAgICAgICAgbnVsbCwKICAgICAgICAgIDIsCiAgICAgICAgKX1gLAogICAgICApOwogICAgfQoKICAgIC8vIElmIGl0J3MgYSByZXF1ZXN0IG1lc3NhZ2UsIHJlc29sdmUgaXQgdG8gYSBmdW5jdGlvbiBjYWxsIGFuZCAicmV0dXJuIgogICAgLy8gdGhlIHZhbHVlIGJ5IHNlbmRpbmcgYSA6cmVzcG9uc2UgbWVzc2FnZSBvdmVyIHRoZSB3ZWJzb2NrZXQgaW5zdGVhZC4KICAgIGNvbnN0IHN0YWdlcyA9IGV2ZW50TmFtZS5zcGxpdChgOmApOwogICAgaWYgKERFQlVHKSBjb25zb2xlLmxvZyhgWyR7cmVjZWl2ZXJ9XSByb3V0ZXI6IHN0YWdlczpgLCBzdGFnZXMpOwoKICAgIGxldCBjYWxsYWJsZSA9IG9yaWdpbjsKICAgIGNvbnN0IFtmaXJzdF0gPSBzdGFnZXM7CiAgICBsZXQgZm9yYmlkZGVuID0gb3JpZ2luLl9fcHJvdG9fXz8uY29uc3RydWN0b3IuZGlzYWxsb3dlZENhbGxzID8/IFtdOwoKICAgIGxldCBlcnJvciA9IHVuZGVmaW5lZDsKICAgIGxldCByZXNwb25zZSA9IHVuZGVmaW5lZDsKCiAgICAvLyBBcmUgd2UgZXZlbiBhbGxvd2VkIHRvIHJlc29sdmUgdGhpcyBjaGFpbj8KICAgIGlmIChmaXJzdCAmJiBmb3JiaWRkZW4uaW5jbHVkZXMoZmlyc3QpKSB7CiAgICAgIGVycm9yID0gYElsbGVnYWwgY2FsbDogJHtmaXJzdH0gaXMgYSBwcm90ZWN0ZWQgcHJvcGVydHlgOwogICAgfQoKICAgIC8vIFdlIGFyZTogZmluZCB0aGUgYWN0dWFsIGZ1bmN0aW9uIHRvIGNhbGwuCiAgICBpZiAoIWVycm9yKSB7CiAgICAgIHRyeSB7CiAgICAgICAgd2hpbGUgKHN0YWdlcy5sZW5ndGgpIHsKICAgICAgICAgIGNvbnN0IHN0YWdlID0gc3RhZ2VzLnNoaWZ0KCk7CiAgICAgICAgICBpZiAoREVCVUcpIGNvbnNvbGUubG9nKGBjaGVja2luZyAke3N0YWdlfWApOwogICAgICAgICAgY2FsbGFibGUgPSBjYWxsYWJsZVtzdGFnZV07CiAgICAgICAgfQogICAgICAgIC8vIElmIHRoaXMgY29kZSBydW5zIG9uIHRoZSBzZXJ2ZXIsIHRoZSBmdW5jdGlvbiBuZWVkcyB0byBiZQogICAgICAgIC8vIGNhbGxlZCB3aXRoIHRoZSBjbGllbnQgcHJveHkgYXMgZmlyc3QgYXJndW1lbnQuCiAgICAgICAgaWYgKHJlY2VpdmVyID09PSBgc2VydmVyYCkgcGF5bG9hZC51bnNoaWZ0KHRoaXNbUFJPWFldKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIC8vICJmdW5jdGlvbiBub3QgZm91bmQiIGRvZXNuJ3QgY291bnQgYXMgZXJyb3IgImhlcmUiLgogICAgICAgIC8vIEluc3RlYWQsIHdlIHNlbmQgdGhhdCBiYWNrIHRvIHRoZSBjYWxsZXIuCiAgICAgICAgaWYgKERFQlVHKQogICAgICAgICAgY29uc29sZS5lcnJvcihgY2Fubm90IHJlc29sdmUgJHtldmVudE5hbWV9IG9uICR7cmVjZWl2ZXJ9YCwgZSk7CiAgICAgICAgZXJyb3IgPSBlLm1lc3NhZ2U7CiAgICAgIH0KICAgIH0KCiAgICAvLyBSZXNvbHZlIHRoZSBmdW5jdGlvbiBhbmQgdGhlbiBzZW5kIHRoZSByZXN1bHQgYXMgOnJlc3BvbnNlLCBtYWtpbmcKICAgIC8vIHN1cmUgdG8gdGFrZSBpbnRvIGFjY291bnQgdGhhdCBhIGNhbGwgaXRzZWxmIG1pZ2h0IHRocm93LgogICAgaWYgKCFlcnJvcikgewogICAgICB0cnkgewogICAgICAgIHJlc3BvbnNlID0gKGF3YWl0IGNhbGxhYmxlLmJpbmQob3JpZ2luKSguLi5wYXlsb2FkKSkgPz8gdHJ1ZTsKICAgICAgICAvLyBJZiB0aGlzIGlzIGEgd2ViY2xpZW50LCBhbmQgdGhlcmUgaXMgYSBicm93c2VyIGNvbm5lY3RlZCwKICAgICAgICAvLyBhbHNvIG1ha2Ugc3VyZSB0byB0cmlnZ2VyIGEgc3RhdGUgc3luYywgc28gdGhhdCBjbGllbnQgY29kZQogICAgICAgIC8vIGRvZXMgbm90IG5lZWQgdG8gaW5jbHVkZSBzZXRTdGF0ZSBjYWxscyBhbGwgb3ZlciB0aGUgcGxhY2UuCiAgICAgICAgaWYgKHJlY2VpdmVyID09PSBDTElFTlQgJiYgb3JpZ2luLmJyb3dzZXIpIHsKICAgICAgICAgIG9yaWdpbi5zZXRTdGF0ZShvcmlnaW4uc3RhdGUpOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGlmIChERUJVRykKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoCiAgICAgICAgICAgIGBmdW5jdGlvbiBpbnZvY2F0aW9uIGZvciAke2V2ZW50TmFtZX0gZmFpbGVkIG9uICR7cmVjZWl2ZXJ9LCBwYXlsb2FkOmAsCiAgICAgICAgICAgIHBheWxvYWQsCiAgICAgICAgICApOwogICAgICAgIGlmIChERUJVRykgY29uc29sZS5lcnJvcihlKTsKICAgICAgICBlcnJvciA9IGBDYW5ub3QgY2FsbCBbWyR7cmVjZWl2ZXJ9XV0uJHtldmVudE5hbWUucmVwbGFjZUFsbCgKICAgICAgICAgIGA6YCwKICAgICAgICAgIGAuYCwKICAgICAgICApfSwgZnVuY3Rpb24gaXMgbm90IGRlZmluZWQuYDsKICAgICAgfQogICAgfQoKICAgIC8vIFNlbmQgb2ZmIGEgcmVzcG9uc2UgbWVzc2FnZSB3aXRoIGVpdGhlciB0aGUgcmVzdWx0LCBvciB0aGUgZXJyb3IuCiAgICBjb25zdCByZXNwb25zZU5hbWUgPSBnZXRSZXNwb25zZU5hbWUoZXZlbnROYW1lKTsKICAgIGlmIChERUJVRykKICAgICAgY29uc29sZS5sb2coYFske3JlY2VpdmVyfV0gc2VuZGluZyAke3Jlc3BvbnNlTmFtZX1gLCB7CiAgICAgICAgcGF5bG9hZDogcmVzcG9uc2UsCiAgICAgICAgZXJyb3IsCiAgICAgIH0pOwogICAgc3VwZXIuc2VuZCgKICAgICAgSlNPTi5zdHJpbmdpZnkoeyBuYW1lOiByZXNwb25zZU5hbWUsIHBheWxvYWQ6IHJlc3BvbnNlLCBlcnJvciB9KSwKICAgICk7CiAgfQoKICAvKioKICAgKiB0aGlzLnVwZ3JhZGVkLm9uKCkgbWFkZSB0byB3b3JrIGxpa2UgLmFkZEV2ZW50TGlzdGVuZXIoKQogICAqLwogIF9fb24oZXZlbnROYW1lLCBoYW5kbGVyKSB7CiAgICBjb25zdCB7IFtIQU5ETEVSU106IGhhbmRsZXJzIH0gPSB0aGlzOwogICAgaWYgKCFoYW5kbGVyc1tldmVudE5hbWVdKSBoYW5kbGVyc1tldmVudE5hbWVdID0gW107CiAgICBoYW5kbGVyc1tldmVudE5hbWVdLnB1c2goaGFuZGxlcik7CiAgICAvLyByZXR1cm4gdGhlIGNvcnJlc3BvbmRpbmcgIm9mZiIgZnVuY3Rpb24sIGZvciBjb252ZW5pZW5jZS4KICAgIHJldHVybiAoKSA9PiB0aGlzLl9fb2ZmKGV2ZW50TmFtZSwgaGFuZGxlcik7CiAgfQoKICAvKioKICAgKiB0aGlzLnVwZ3JhZGVkLm9mZigpIG1hZGUgdG8gd29yayBsaWtlIC5yZW1vdmVFdmVudExpc3RlbmVyKCkKICAgKi8KICBfX29mZihldmVudE5hbWUsIGhhbmRsZXIpIHsKICAgIGNvbnN0IHsgW0hBTkRMRVJTXTogaGFuZGxlcnMgfSA9IHRoaXM7CiAgICBpZiAoIWhhbmRsZXJzW2V2ZW50TmFtZV0pIHJldHVybjsKICAgIGNvbnN0IHBvcyA9IGhhbmRsZXJzW2V2ZW50TmFtZV0uaW5kZXhPZihoYW5kbGVyKTsKICAgIGhhbmRsZXJzW2V2ZW50TmFtZV0uc3BsaWNlKHBvcywgMSk7CiAgfQoKICAvKioKICAgKiBBZGQgYSBwcm9taXNlLWJhc2VkIGVtaXQvcmVjZWl2ZSB0byB0aGUgc29ja2V0LCBzbyB0aGF0IGNhbGxpbmcgY29kZSBjYW4gYGF3YWl0YCB0aGUgcmVzcG9uc2UuCiAgICoKICAgKiBOb3RlIHRoYXQgdGhlcmUgaXMgYW4gb3B0aW9uYWwgdGhpcmQgYXJndW1lbnQgYHRpbWVvdXRgIHRoYXQgY2FuIGJlIHVzZWQgdG8gc2F5IGhvdyBsb25nIHRoZQogICAqIGVtaXQgc2hvdWxkIHdhaXQgYmVmb3JlIGRlY2lkaW5nIHRoZXJlIGlzIG5vIHJlc3BvbnNlIGZvcnRoY29taW5nIGFuZCB0byBjbGVhbiB1cCB0aGUgZXZlbnQKICAgKiBsaXN0ZW5lciBmb3IgdGhhdCByZXNwb25zZS4gVGhlIGRlZmF1bHQgdGltZW91dCBpcyAxMDAwbXMuCiAgICovCiAgYXN5bmMgX19zZW5kKGV2ZW50TmFtZSwgZGF0YSA9IHt9LCB0aW1lb3V0ID0gMTAwMCkgewogICAgY29uc3QgeyBbUkVDRUlWRVJdOiByZWNlaXZlciwgW1JFTU9URV06IHJlbW90ZSB9ID0gdGhpczsKICAgIGlmIChERUJVRykKICAgICAgY29uc29sZS5sb2coYFske3JlY2VpdmVyfV0gc2VuZGluZyBbJHtldmVudE5hbWV9XSB0byBbJHtyZW1vdGV9XTpgLCBkYXRhKTsKICAgIHJldHVybiBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgIGNvbnN0IHJlc3BvbnNlTmFtZSA9IGdldFJlc3BvbnNlTmFtZShldmVudE5hbWUpOwoKICAgICAgLy8gY2xlYW51cCBmdW5jdGlvbiBmb3IgdGhlIGV2ZW50IGxpc3RlbmVyCiAgICAgIGxldCBjbGVhbnVwID0gKGRhdGEgPSB1bmRlZmluZWQpID0+IHsKICAgICAgICBpZiAoREVCVUcpIGNvbnNvbGUubG9nKGBbJHtyZWNlaXZlcn1dIGNsZWFudXBgKTsKICAgICAgICAvLyBjbGVhbiB1cCBhbmQgYmVjb21lIGEgbm9vcCBzbyB3ZSBjYW4ndCBiZSByZXRyaWdnZXJlZC4KICAgICAgICB0aGlzLl9fb2ZmKHJlc3BvbnNlTmFtZSwgaGFuZGxlcik7CiAgICAgICAgY2xlYW51cCA9ICgpID0+IHt9OwogICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgIH07CgogICAgICAvLyBJbiBvcmRlciB0byByZXNvbHZlIHRoZSBQcm9taXNlLCB3ZSB3aWxsIGJlIGxpc3RlbmluZwogICAgICAvLyBmb3IgdGhhdCBldmVudE5hbWU6cmVzcG9uc2UsIGFuZCB3aGVuIHdlIHJlY2VpdmUgaXQsCiAgICAgIC8vIHdlJ2xsIGltbWVkaWF0ZWx5IFNUT1AgbGlzdGVuaW5nIGZvciBzaW1pbGFyIHJlc3BvbnNlcwogICAgICAvLyBiZWNhdXNlIHdlIG5vIGxvbmdlciBjYXJlLgogICAgICBjb25zdCBoYW5kbGVyID0gKGRhdGEpID0+IGNsZWFudXAoZGF0YSk7CgogICAgICAvLyBGaXJzdCwgbWFrZSBzdXJlIHdlJ3JlIHJlYWR5IHRvIHJlY2VpdmUgdGhlIHJlc3BvbnNlLi4uCiAgICAgIHRoaXMuX19vbihyZXNwb25zZU5hbWUsIChkYXRhKSA9PiB7CiAgICAgICAgaWYgKERFQlVHKQogICAgICAgICAgY29uc29sZS5sb2coCiAgICAgICAgICAgIGBbJHtyZWNlaXZlcn1dIGhhbmRsaW5nIHJlc3BvbnNlIGZvciAke2V2ZW50TmFtZX0gZnJvbSBbJHtyZW1vdGV9XTpgLAogICAgICAgICAgKTsKICAgICAgICBoYW5kbGVyKGRhdGEpOwogICAgICB9KTsKCiAgICAgIC8vIEFuZCB0aGVuLCBzZW5kIHRoZSBldmVudCBvZmYgdG8gdGhlIGNsaWVudC4KICAgICAgY29uc3Qgc2VuZEV2ZW50ID0gKCkgPT4gewogICAgICAgIGlmIChERUJVRykKICAgICAgICAgIGNvbnNvbGUubG9nKAogICAgICAgICAgICBgKHJhdykgc2VuZGluZyAke2V2ZW50TmFtZX0gZnJvbSAke3JlY2VpdmVyfSB0byAke3JlbW90ZX1gLAogICAgICAgICAgKTsKICAgICAgICBzdXBlci5zZW5kKAogICAgICAgICAgSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgICBuYW1lOiBldmVudE5hbWUsCiAgICAgICAgICAgIHBheWxvYWQ6IGRhdGEsCiAgICAgICAgICB9KSwKICAgICAgICApOwogICAgICB9OwoKICAgICAgLy8gV2UgbWF5IGJlIHRyeWluZyB0byBzZW5kIGJlZm9yZSB0aGUgc29ja2V0IGlzIG9wZW4gaW4gYnJvd3NlciBsYW5kLAogICAgICAvLyBzbyBpZiB0aGUgc29ja2V0J3Mgbm90IHJlYWR5LCAicXVldWUiIHRoZSBldmVudCB0byBmaXJlIG9uIG9wZW4uCiAgICAgIGlmIChzdXBlci5yZWFkeVN0YXRlID09PSAxKSBzZW5kRXZlbnQoKTsKICAgICAgZWxzZSBzdXBlci5vbm9wZW4gPSBzZW5kRXZlbnQ7CgogICAgICAvLyBBbmQgbWFrZSBzdXJlIHRoYXQgaWYgbm8gcmVzcG9uc2UgaGFzIG9jY3VycmVkIHdpdGhpbgogICAgICAvLyBgdGltZW91dGAgbWlsbGlzZWNvbmRzLCB3ZSBjbGVhbiB1cCB0aGUgbGlzdGVuZXIuCiAgICAgIGlmIChpc0Zpbml0ZSh0aW1lb3V0KSkgewogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gY2xlYW51cCgpLCB0aW1lb3V0KTsKICAgICAgfQogICAgfSk7CiAgfQp9CgovKioKICogQSBzb2NrZXQgcHJveHkgZm9yIFJQQyBwdXJwb3Nlcy4KICovCmNsYXNzIFNvY2tldFByb3h5IGV4dGVuZHMgRnVuY3Rpb24gewogIGNvbnN0cnVjdG9yKHNvY2tldCwgcmVjZWl2ZXIsIHJlbW90ZSwgcGF0aCA9IGBgKSB7CiAgICBzdXBlcigpOwogICAgdGhpc1tSRUNFSVZFUl0gPSByZWNlaXZlcjsKICAgIHRoaXNbUkVNT1RFXSA9IHJlbW90ZTsKICAgIHRoaXMuaWQgPSB1dWlkKCk7CiAgICB0aGlzLnBhdGggPSBwYXRoOwogICAgdGhpcy5zb2NrZXQgPSBzb2NrZXQ7CiAgICByZXR1cm4gbmV3IFByb3h5KHRoaXMsIHsKICAgICAgZ2V0OiAoXywgcHJvcCkgPT4gewogICAgICAgIGlmIChwcm9wID09PSAiaWQiKSByZXR1cm4gdGhpcy5pZDsKICAgICAgICBpZiAocHJvcCA9PT0gInNvY2tldCIpIHJldHVybiB0aGlzLnNvY2tldDsKICAgICAgICAvLyBAdHMtaWdub3JlOiB3ZSdyZSBuZXZlciBpbnZva2luZyB0aGlzIHdpdGggU3ltYm9sIGFzIHNlY29uZCBhcmd1bWVudAogICAgICAgIHJldHVybiBuZXcgU29ja2V0UHJveHkoc29ja2V0LCByZWNlaXZlciwgcmVtb3RlLCBgJHtwYXRofToke3Byb3B9YCk7CiAgICAgIH0sCiAgICAgIGFwcGx5OiBhc3luYyAoXywgX18sIGFyZ3MpID0+IHsKICAgICAgICBpZiAoREVCVUcpCiAgICAgICAgICBjb25zb2xlLmxvZygKICAgICAgICAgICAgYFtTUGFwcGx5XSBzZW5kaW5nICR7dGhpcy5wYXRoLnN1YnN0cmluZygxKX0gcmVjZWl2ZXIgJHsKICAgICAgICAgICAgICB0aGlzW1JFQ0VJVkVSXQogICAgICAgICAgICB9IHRvICR7dGhpc1tSRU1PVEVdfWAsCiAgICAgICAgICApOwoKICAgICAgICBjb25zdCBkYXRhID0gYXdhaXQgdGhpcy5zb2NrZXQudXBncmFkZWQuc2VuZCgKICAgICAgICAgIHRoaXMucGF0aC5zdWJzdHJpbmcoMSksCiAgICAgICAgICBhcmdzLAogICAgICAgICAgdGhpc1tSRU1PVEVdID09PSBCUk9XU0VSID8gSW5maW5pdHkgOiB1bmRlZmluZWQsCiAgICAgICAgKTsKCiAgICAgICAgaWYgKGRhdGEgaW5zdGFuY2VvZiBSUENFcnJvcikgewogICAgICAgICAgY29uc3QgYXJnc3RyID0gWy4uLm5ldyBBcnJheShhcmdzLmxlbmd0aCldCiAgICAgICAgICAgIC5tYXAoKF8sIGkpID0+IFN0cmluZy5mcm9tQ2hhckNvZGUoOTcgKyBpKSkKICAgICAgICAgICAgLmpvaW4oYCxgKTsKCiAgICAgICAgICBpZiAoREVCVUcpCiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoCiAgICAgICAgICAgICAgYEVSUk9SIGNhbGxpbmcgW1ske2RhdGEub3JpZ2luTmFtZX1dXS4ke3RoaXMucGF0aAogICAgICAgICAgICAgICAgLnN1YnN0cmluZygxKQogICAgICAgICAgICAgICAgLnJlcGxhY2VBbGwoYDpgLCBgLmApfSgke2FyZ3N0cn0pOiAke2RhdGEubWVzc2FnZX1gLAogICAgICAgICAgICApOwoKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihkYXRhLm1lc3NhZ2UpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgIH0sCiAgICB9KTsKICB9Cn0KCi8qKgogKiBDcmVhdGUgYSBwcm94aWVkIHNvY2tldCB3aGVyZSB0aGUgY2FsbGVyIGxpdGVyYWxseSBkb2Vzbid0IG5lZWQKICogdG8gY2FyZSwgdGhleSBqdXN0IG5lZWQgdG8gY2FsbCBmdW5jdGlvbnMgYXMgaWYgdGhleSdyZSBsb2NhbHMuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSByZWNlaXZlciBUaGUgbmFtZSBvZiB0aGUgcmVjZWl2ZXIgZm9yIHRoaXMgc29ja2V0CiAqIEBwYXJhbSB7c3RyaW5nfSByZW1vdGUgVGhlIG5hbWUgb2YgdGhlIHJlbW90ZSBmb3IgdGhpcyBzb2NrZXQKICogQHBhcmFtIHsqfSBvcmlnaW4gVGhlIGNhbGxpbmcgb2JqZWN0LCB1c2VkIGZvciB0aGluZ3MgbGlrZSAiaWxsZWdhbCBmbmFtZXMiLCBzdGF0ZSBtYW5hZ2VtZW50LCBldGMuCiAqIEBwYXJhbSB7Kn0gc29ja2V0IFRoZSBzb2NrZXQgd2UncmUgd3JhcHBpbmcuCiAqIEByZXR1cm5zCiAqLwpleHBvcnQgZnVuY3Rpb24gcHJveHlTb2NrZXQocmVjZWl2ZXIsIHJlbW90ZSwgb3JpZ2luLCBzb2NrZXQpIHsKICBzb2NrZXQgPSBVcGdyYWRlZFNvY2tldC51cGdyYWRlKHNvY2tldCwgb3JpZ2luLCByZWNlaXZlciwgcmVtb3RlKTsKICByZXR1cm4gKHNvY2tldFtQUk9YWV0gPSBuZXcgU29ja2V0UHJveHkoc29ja2V0LCByZWNlaXZlciwgcmVtb3RlKSk7Cn0KCmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVCcm93c2VyQ2xpZW50KEJyb3dzZXJDbGllbnRDbGFzcykgewogICAgY29uc3QgcHJvcGVydHlDb25maWcgPSB7IHdyaXRhYmxlOiBmYWxzZSwgY29uZmlndXJhYmxlOiBmYWxzZSwgZW51bWVyYWJsZTogZmFsc2V9OwogICAgY29uc3QgYnJvd3NlckNsaWVudCA9IG5ldyBCcm93c2VyQ2xpZW50Q2xhc3MoKTsKCiAgICAvLyBjcmVhdGUgdGhlIHdlYiBzb2NrZXQgY29ubmVjdGlvbjoKICAgIGNvbnN0IHNvY2tldCA9IG5ldyBXZWJTb2NrZXQod2luZG93LmxvY2F0aW9uLnRvU3RyaW5nKCkucmVwbGFjZSgiaHR0cCIsICJ3cyIpKTsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShicm93c2VyQ2xpZW50LCAic29ja2V0IiwgewogICAgICAuLi5wcm9wZXJ0eUNvbmZpZywKICAgICAgdmFsdWU6IHNvY2tldCwKICAgIH0pOwoKICAgIC8vIGNyZWF0ZSBhIHByb3h5IGZvciB0aGUgKHdlYmNsaWVudCB0dW5uZWwgdG8gdGhlKSBzZXJ2ZXI6CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoYnJvd3NlckNsaWVudCwgInNlcnZlciIsIHsKICAgICAgLi4ucHJvcGVydHlDb25maWcsCiAgICAgIHZhbHVlOiBwcm94eVNvY2tldCgiYnJvd3NlciIsICJ3ZWJjbGllbnQiLCBicm93c2VyQ2xpZW50LCBzb2NrZXQpLAogICAgfSk7CgogICAgYnJvd3NlckNsaWVudC5zdGF0ZSA9IHt9OwogICAgYnJvd3NlckNsaWVudC5pbml0Py4oKTsKICAgIHJldHVybiBicm93c2VyQ2xpZW50OwogIH07CihmdW5jdGlvbihwLHIpeyJvYmplY3QiPT09dHlwZW9mIGV4cG9ydHMmJiJ1bmRlZmluZWQiIT09dHlwZW9mIG1vZHVsZT9yKGV4cG9ydHMpOiJmdW5jdGlvbiI9PT10eXBlb2YgZGVmaW5lJiZkZWZpbmUuYW1kP2RlZmluZShbImV4cG9ydHMiXSxyKToocD0idW5kZWZpbmVkIiE9PXR5cGVvZiBnbG9iYWxUaGlzP2dsb2JhbFRoaXM6cHx8c2VsZixyKHAucmZjNjkwMj17fSkpfSkodGhpcyxmdW5jdGlvbihwKXtmdW5jdGlvbiByKGEpe3JldHVybiBhLnJlcGxhY2UoL34xL2csIi8iKS5yZXBsYWNlKC9+MC9nLCJ+Iil9ZnVuY3Rpb24gRShhKXtyZXR1cm4gYS5yZXBsYWNlKC9+L2csIn4wIikucmVwbGFjZSgvXC8vZywifjEiKX1mdW5jdGlvbiB6KGEpe3JldHVybiB2b2lkIDA9PT1hPyJ1bmRlZmluZWQiOm51bGw9PT1hPyJudWxsIjpBcnJheS5pc0FycmF5KGEpPyJhcnJheSI6dHlwZW9mIGF9ZnVuY3Rpb24gdihhKXtpZihudWxsPT1hfHwib2JqZWN0IiE9dHlwZW9mIGEpcmV0dXJuIGE7CmlmKGEuY29uc3RydWN0b3I9PUFycmF5KXt2YXIgYj1hLmxlbmd0aCxjPUFycmF5KGIpO2ZvcihsZXQgZD0wO2Q8YjtkKyspY1tkXT12KGFbZF0pO3JldHVybiBjfWlmKGEuY29uc3RydWN0b3I9PURhdGUpcmV0dXJuIG5ldyBEYXRlKCthKTtiPXt9O2ZvcihjIGluIGEpdy5jYWxsKGEsYykmJihiW2NdPXYoYVtjXSkpO3JldHVybiBifWZ1bmN0aW9uIEYoe29wOmF9KXtyZXR1cm4icmVtb3ZlIj09PWF8fCJyZXBsYWNlIj09PWF8fCJjb3B5Ij09PWF8fCJtb3ZlIj09PWF9ZnVuY3Rpb24gQShhLGIpe2NvbnN0IGM9e307Zm9yKGNvbnN0IGQgaW4gYSl3LmNhbGwoYSxkKSYmdm9pZCAwIT09YVtkXSYmKGNbZF09MSk7Zm9yKGNvbnN0IGQgaW4gYil3LmNhbGwoYixkKSYmdm9pZCAwIT09YltkXSYmZGVsZXRlIGNbZF07cmV0dXJuIE9iamVjdC5rZXlzKGMpfWZ1bmN0aW9uIEcoYSl7Y29uc3QgYj1hLmxlbmd0aCxjPXt9O2ZvcihsZXQgZD0wO2Q8YjtkKyspe2NvbnN0IGU9YVtkXTtmb3IoY29uc3QgZiBpbiBlKXcuY2FsbChlLApmKSYmdm9pZCAwIT09ZVtmXSYmKGNbZl09KGNbZl18fDApKzEpfWZvcihjb25zdCBkIGluIGMpY1tkXTxiJiZkZWxldGUgY1tkXTtyZXR1cm4gT2JqZWN0LmtleXMoYyl9ZnVuY3Rpb24geChhLGIpe3JldHVybntvcGVyYXRpb25zOmEub3BlcmF0aW9ucy5jb25jYXQoYiksY29zdDphLmNvc3QrMX19ZnVuY3Rpb24gSChhLGIsYyxkPXEpe2Z1bmN0aW9uIGUoayxnKXtjb25zdCBoPWAke2t9LCR7Z31gO3ZhciBsPWZbaF07aWYodm9pZCAwPT09bCl7aWYoMDxrJiYwPGcmJiFkKGFbay0xXSxiW2ctMV0sYy5hZGQoU3RyaW5nKGstMSkpKS5sZW5ndGgpbD1lKGstMSxnLTEpO2Vsc2V7bD1bXTtpZigwPGspe3ZhciB0PWUoay0xLGcpO2wucHVzaCh4KHQse29wOiJyZW1vdmUiLGluZGV4OmstMX0pKX0wPGcmJih0PWUoayxnLTEpLGwucHVzaCh4KHQse29wOiJhZGQiLGluZGV4OmstMSx2YWx1ZTpiW2ctMV19KSkpOzA8ayYmMDxnJiYodD1lKGstMSxnLTEpLGwucHVzaCh4KHQse29wOiJyZXBsYWNlIiwKaW5kZXg6ay0xLG9yaWdpbmFsOmFbay0xXSx2YWx1ZTpiW2ctMV19KSkpO2w9bC5zb3J0KChJLEopPT5JLmNvc3QtSi5jb3N0KVswXX1mW2hdPWx9cmV0dXJuIGx9Y29uc3QgZj17IjAsMCI6e29wZXJhdGlvbnM6W10sY29zdDowfX0sQj1pc05hTihhLmxlbmd0aCl8fDA+PWEubGVuZ3RoPzA6YS5sZW5ndGg7dmFyIHU9aXNOYU4oYi5sZW5ndGgpfHwwPj1iLmxlbmd0aD8wOmIubGVuZ3RoO3U9ZShCLHUpLm9wZXJhdGlvbnM7W3VdPXUucmVkdWNlKChbayxnXSxoKT0+e2lmKCJhZGQiPT09aC5vcCl7dmFyIGw9aC5pbmRleCsxK2c7aD17b3A6aC5vcCxwYXRoOmMuYWRkKGw8QitnP1N0cmluZyhsKToiLSIpLnRvU3RyaW5nKCksdmFsdWU6aC52YWx1ZX07cmV0dXJuW2suY29uY2F0KGgpLGcrMV19aWYoInJlbW92ZSI9PT1oLm9wKXJldHVybiBoPXtvcDpoLm9wLHBhdGg6Yy5hZGQoU3RyaW5nKGguaW5kZXgrZykpLnRvU3RyaW5nKCl9LFtrLmNvbmNhdChoKSxnLTFdO2w9Yy5hZGQoU3RyaW5nKGguaW5kZXgrCmcpKTtoPWQoaC5vcmlnaW5hbCxoLnZhbHVlLGwpO3JldHVybltrLmNvbmNhdCguLi5oKSxnXX0sW1tdLDBdKTtyZXR1cm4gdX1mdW5jdGlvbiBLKGEsYixjLGQ9cSl7Y29uc3QgZT1bXTtBKGEsYikuZm9yRWFjaChmPT57ZS5wdXNoKHtvcDoicmVtb3ZlIixwYXRoOmMuYWRkKGYpLnRvU3RyaW5nKCl9KX0pO0EoYixhKS5mb3JFYWNoKGY9PntlLnB1c2goe29wOiJhZGQiLHBhdGg6Yy5hZGQoZikudG9TdHJpbmcoKSx2YWx1ZTpiW2ZdfSl9KTtHKFthLGJdKS5mb3JFYWNoKGY9PntlLnB1c2goLi4uZChhW2ZdLGJbZl0sYy5hZGQoZikpKX0pO3JldHVybiBlfWZ1bmN0aW9uIHEoYSxiLGMsZD1xKXtpZihhPT09YilyZXR1cm5bXTtjb25zdCBlPXooYSksZj16KGIpO3JldHVybiJhcnJheSI9PWUmJiJhcnJheSI9PWY/SChhLGIsYyxkKToib2JqZWN0Ij09ZSYmIm9iamVjdCI9PWY/SyhhLGIsYyxkKTpbe29wOiJyZXBsYWNlIixwYXRoOmMudG9TdHJpbmcoKSx2YWx1ZTpifV19ZnVuY3Rpb24geShhLApiLGMpe0FycmF5LmlzQXJyYXkoYSk/Ii0iPT1iP2EucHVzaChjKTooYj1wYXJzZUludChiLDEwKSxhLnNwbGljZShiLDAsYykpOmFbYl09Y31mdW5jdGlvbiBDKGEsYil7QXJyYXkuaXNBcnJheShhKT8oYj1wYXJzZUludChiLDEwKSxhLnNwbGljZShiLDEpKTpkZWxldGUgYVtiXX1mdW5jdGlvbiBMKGEsYil7YT1tLmZyb21KU09OKGIucGF0aCkuZXZhbHVhdGUoYSk7aWYobnVsbD09PWEucGFyZW50KXJldHVybiBuZXcgbihiLnBhdGgpO2lmKEFycmF5LmlzQXJyYXkoYS5wYXJlbnQpKXtpZihwYXJzZUludChhLmtleSwxMCk+PWEucGFyZW50Lmxlbmd0aClyZXR1cm4gbmV3IG4oYi5wYXRoKX1lbHNlIGlmKHZvaWQgMD09PWEudmFsdWUpcmV0dXJuIG5ldyBuKGIucGF0aCk7YS5wYXJlbnRbYS5rZXldPWIudmFsdWU7cmV0dXJuIG51bGx9ZnVuY3Rpb24gTShhLGIpe3N3aXRjaChiLm9wKXtjYXNlICJhZGQiOnJldHVybiBhPW0uZnJvbUpTT04oYi5wYXRoKS5ldmFsdWF0ZShhKSx2b2lkIDA9PT0KYS5wYXJlbnQ/Yj1uZXcgbihiLnBhdGgpOih5KGEucGFyZW50LGEua2V5LHYoYi52YWx1ZSkpLGI9bnVsbCksYjtjYXNlICJyZW1vdmUiOnJldHVybiBhPW0uZnJvbUpTT04oYi5wYXRoKS5ldmFsdWF0ZShhKSx2b2lkIDA9PT1hLnZhbHVlP2I9bmV3IG4oYi5wYXRoKTooQyhhLnBhcmVudCxhLmtleSksYj1udWxsKSxiO2Nhc2UgInJlcGxhY2UiOnJldHVybiBMKGEsYik7Y2FzZSAibW92ZSI6dmFyIGM9bS5mcm9tSlNPTihiLmZyb20pLmV2YWx1YXRlKGEpO3ZvaWQgMD09PWMudmFsdWU/Yj1uZXcgbihiLmZyb20pOihhPW0uZnJvbUpTT04oYi5wYXRoKS5ldmFsdWF0ZShhKSx2b2lkIDA9PT1hLnBhcmVudD9iPW5ldyBuKGIucGF0aCk6KEMoYy5wYXJlbnQsYy5rZXkpLHkoYS5wYXJlbnQsYS5rZXksYy52YWx1ZSksYj1udWxsKSk7cmV0dXJuIGI7Y2FzZSAiY29weSI6cmV0dXJuIGM9bS5mcm9tSlNPTihiLmZyb20pLmV2YWx1YXRlKGEpLHZvaWQgMD09PWMudmFsdWU/Yj1uZXcgbihiLmZyb20pOgooYT1tLmZyb21KU09OKGIucGF0aCkuZXZhbHVhdGUoYSksdm9pZCAwPT09YS5wYXJlbnQ/Yj1uZXcgbihiLnBhdGgpOih5KGEucGFyZW50LGEua2V5LHYoYy52YWx1ZSkpLGI9bnVsbCkpLGI7Y2FzZSAidGVzdCI6cmV0dXJuIGE9bS5mcm9tSlNPTihiLnBhdGgpLmV2YWx1YXRlKGEpLGI9cShhLnZhbHVlLGIudmFsdWUsbmV3IG0pLmxlbmd0aD9uZXcgTihhLnZhbHVlLGIudmFsdWUpOm51bGwsYn1yZXR1cm4gbmV3IE8oYil9ZnVuY3Rpb24gUChhKXtmdW5jdGlvbiBiKGMsZCxlKXtjb25zdCBmPWEoYyxkLGUpO3JldHVybiBBcnJheS5pc0FycmF5KGYpP2Y6cShjLGQsZSxiKX1yZXR1cm4gYn1mdW5jdGlvbiBEKGEsYil7YT1tLmZyb21KU09OKGIpLmV2YWx1YXRlKGEpO2lmKHZvaWQgMCE9PWEpcmV0dXJue29wOiJ0ZXN0IixwYXRoOmIsdmFsdWU6YS52YWx1ZX19Y2xhc3MgbXtjb25zdHJ1Y3RvcihhPVsiIl0pe3RoaXMudG9rZW5zPWF9c3RhdGljIGZyb21KU09OKGEpe2NvbnN0IGI9CmEuc3BsaXQoIi8iKS5tYXAocik7aWYoIiIhPT1iWzBdKXRocm93IEVycm9yKGBJbnZhbGlkIEpTT04gUG9pbnRlcjogJHthfWApO3JldHVybiBuZXcgbShiKX10b1N0cmluZygpe3JldHVybiB0aGlzLnRva2Vucy5tYXAoRSkuam9pbigiLyIpfWV2YWx1YXRlKGEpe2xldCBiPW51bGwsYz0iIjtmb3IobGV0IGQ9MSxlPXRoaXMudG9rZW5zLmxlbmd0aDtkPGU7ZCsrKWI9YSxjPXRoaXMudG9rZW5zW2RdLCJfX3Byb3RvX18iIT1jJiYiY29uc3RydWN0b3IiIT1jJiYicHJvdG90eXBlIiE9YyYmKGE9KGJ8fHt9KVtjXSk7cmV0dXJue3BhcmVudDpiLGtleTpjLHZhbHVlOmF9fWdldChhKXtyZXR1cm4gdGhpcy5ldmFsdWF0ZShhKS52YWx1ZX1zZXQoYSxiKXtmb3IobGV0IGM9MSxkPXRoaXMudG9rZW5zLmxlbmd0aC0xLGU9dGhpcy50b2tlbnNbY107YzxkO2MrKylhPShhfHx7fSlbZV07YSYmKGFbdGhpcy50b2tlbnNbdGhpcy50b2tlbnMubGVuZ3RoLTFdXT1iKX1wdXNoKGEpe3RoaXMudG9rZW5zLnB1c2goYSl9YWRkKGEpe2E9CnRoaXMudG9rZW5zLmNvbmNhdChTdHJpbmcoYSkpO3JldHVybiBuZXcgbShhKX19Y29uc3Qgdz1PYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5O2NsYXNzIG4gZXh0ZW5kcyBFcnJvcntjb25zdHJ1Y3RvcihhKXtzdXBlcihgVmFsdWUgcmVxdWlyZWQgYXQgcGF0aDogJHthfWApO3RoaXMucGF0aD1hO3RoaXMubmFtZT0iTWlzc2luZ0Vycm9yIn19Y2xhc3MgTiBleHRlbmRzIEVycm9ye2NvbnN0cnVjdG9yKGEsYil7c3VwZXIoYFRlc3QgZmFpbGVkOiAke2F9ICE9ICR7Yn1gKTt0aGlzLmFjdHVhbD1hO3RoaXMuZXhwZWN0ZWQ9Yjt0aGlzLm5hbWU9IlRlc3RFcnJvciJ9fWNsYXNzIE8gZXh0ZW5kcyBFcnJvcntjb25zdHJ1Y3RvcihhKXtzdXBlcihgSW52YWxpZCBvcGVyYXRpb246ICR7YS5vcH1gKTt0aGlzLm9wZXJhdGlvbj1hO3RoaXMubmFtZT0iSW52YWxpZE9wZXJhdGlvbkVycm9yIn19cC5hcHBseVBhdGNoPWZ1bmN0aW9uKGEsYil7cmV0dXJuIGIubWFwKGM9Pk0oYSxjKSl9OwpwLmNyZWF0ZVBhdGNoPWZ1bmN0aW9uKGEsYixjKXtjb25zdCBkPW5ldyBtO3JldHVybihjP1AoYyk6cSkoYSxiLGQpfTtwLmNyZWF0ZVRlc3RzPWZ1bmN0aW9uKGEsYil7Y29uc3QgYz1bXTtiLmZpbHRlcihGKS5mb3JFYWNoKGQ9Pntjb25zdCBlPUQoYSxkLnBhdGgpO2UmJmMucHVzaChlKTsiZnJvbSJpbiBkJiYoZD1EKGEsZC5mcm9tKSkmJmMucHVzaChkKX0pO3JldHVybiBjfTtPYmplY3QuZGVmaW5lUHJvcGVydHkocCwiX19lc01vZHVsZSIse3ZhbHVlOiEwfSl9KTsK");var $={".html":"text/html",".css":"text/css",".js":"application/javascript",".jpg":"image/jpeg",".png":"image/png"},tg="text/plain";function q(C){let I=Object.keys($).find(l=>C.slice(-l.length)===l);return $[I]||tg}function dg(C,I){return C==="/"?_(I,"index.html"):(C=C.substring(1),C=C.replaceAll("../","/").replace(/\/+/g,"/"),C=_(I,C),C)}function Zg(C,I){console.error(`Can't serve ${C}, so it probably doesn't exist`),I.writeHead(404,{"Content-Type":"text/html"}),I.end("<doctype html><html><body>resource not found</body></html>")}function gg(C,I){return async(g,l)=>{if(g.url.includes("?")){let[d,n]=g.url.split(/\\?\?/);g.url=d,g.params=new URLSearchParams(n)}let c=g.url;if(c==="/favicon.ico")return l.writeHead(200,{"Content-Type":"text/plain"}),l.end("","utf-8");if(c==="/socketless.js")return l.writeHead(200,{"Content-Type":q(".js")}),l.end(D,"utf-8");if(!await I.handle(c,g,l)){var o=dg(g.url,C);ng.readFile(o,(d,n)=>{if(d)return Zg(o,l);l.writeHead(200,{"Content-Type":q(o)}),l.end(n,"utf-8")})}}}var bg=!0,Gg=Symbol("allow self-signed certificates");function Lg(C,I){C=j(C),I=O(I);let g=M(C),l={createServer:function(o){let d,n;o?.constructor===Object?n=o:d=o;let i=d;if(!i){let Z=new w(null),t=(G,m)=>{if(G.url.includes("?")){let[a,A]=G.url.split(/\\?\?/);G.url=a,G.params=new URLSearchParams(A)}Z.handle(G.url,G,m)};i=n?lg.createServer(n,t):Ig.createServer(t),i.addRoute=Z.addRouteHandler.bind(Z),i.removeRoute=Z.removeRoute.bind(Z)}let e=new cg({noServer:!0});i.on("upgrade",(Z,t,G)=>{e.handleUpgrade(Z,t,G,m=>{e.emit("connection",m,Z)})});let s=new I(e,i);return e.on("connection",function(Z){s.connectClientSocket(Z)}),i},createClient:function(o,d,n=C){o=o.replace("http","ws");let i=new sg(o,{rejectUnauthorized:d!==Gg}),e=new n;i.on("close",(...Z)=>e.onDisconnect(...Z));function s(Z){try{let{name:t,payload:G}=JSON.parse(Z);t==="handshake:setid"&&(i.off("message",s),e.setState(G),e.connectServerSocket(i))}catch{}}return i.on("message",s),e},createWebClient:function(o,d,n,i){let e=l.createClient(o,i,g),s=new w(e),Z=gg(d,s),t=n?lg.createServer(n,Z):Ig.createServer(Z),G=new cg({noServer:!0});return t.on("upgrade",(m,a,A)=>{G.handleUpgrade(m,a,A,p=>{G.emit("connection",p,m)})}),e.ws=G,e.webserver=t,G.on("connection",m=>{e.connectBrowserSocket(m),m.on("message",async a=>{a=a.toString();let{name:A,payload:p,error:r}=JSON.parse(a);if(r)throw new Error(r);let u=H(A);if(A==="syncState"){let Y=await e.syncState();return m.send(JSON.stringify({name:u,payload:Y}))}if(A==="quit")return e.quit();if(A==="disconnect")return e.disconnect();if(A.endsWith(F))e.browser.socket.router(a,bg);else{let Y=e.server,B=A.split(":");for(;B.length;)Y=Y[B.shift()];let S=await Y(...p);m.send(JSON.stringify({name:u,payload:S}))}}),m.on("close",()=>{e.disconnectBrowserSocket()})}),t.addRoute=s.addRouteHandler.bind(s),t.removeRoute=s.removeRoute.bind(s),{client:e,clientWebServer:t}}};return l}export{Gg as ALLOW_SELF_SIGNED_CERTS,Lg as linkClasses};
