import gg from"node:http";import Ig from"node:https";import{WebSocket as sg,WebSocketServer as cg}from"ws";import{WebSocket as Cg}from"ws";var F="server",K="client",z="webclient",X="browser";var v=class{constructor(I,g){this.originName=I,this.message=g}},b=!1;function ng(){let C=Date.now().toString(16),I=(1e6*Math.random()|0).toString(16);return`${C}-${I}`}var w=":response",H=C=>`${C}${w}`,k=Symbol("origin"),f=Symbol("proxy"),p=Symbol("receiver"),y=Symbol("remote"),R=Symbol("handlers"),U=class C extends Cg{[k]=void 0;[f]=void 0;[p]="";[y]="";[R]={};constructor(){throw new Error("Cannot create UpgradedSocket instances. Use UpgradedSocket.upgrade(name, origin, socket) instead.")}static upgrade(I,g,c,l){if(I instanceof C)return I;Object.setPrototypeOf(I,C.prototype),I[k]=g,I[p]=c,I[y]=l,I[R]={};let n=I.router.bind(I);return I.on?I.on("message",n):I.onmessage=n,I}get upgraded(){return this.__upgraded||(this.__upgraded={on:(...I)=>this.__on(...I),off:(...I)=>this.__off(...I),send:(...I)=>this.__send(...I)}),this.__upgraded}async router(I,g=!1){let{[k]:c,[p]:l,[y]:n}=this;if(n===X&&!g)return;I.srcElement&&(I=I.data);let Z;try{Z=JSON.parse(I)}catch{return console.error(`Could not parse websocket data: ${I}`)}let{name:e,payload:o,error:i,diff:G,seq_num:s}=Z,{state:t}=Z,m=i?new v(l,i):void 0;if(b&&console.log(`[${l}]/[${n}] router running given:`,{eventName:e,payload:o,errorMsg:i,state:t,diff:G,seq_num:s}),t&&l===X){b&&console.log("handling state update in the browser",t),b&&console.log("origin object:",{origin:c});let d=JSON.parse(JSON.stringify(c.state));if(G){b&&console.log("received diff",t);let Y=t,u;if(s===c.__seq_num+1)c.__seq_num=s,u=JSON.parse(JSON.stringify(d)),b&&console.log("applying patch to",u),rfc6902.applyPatch(u,Y);else{b&&console.log("seq_num mismatch, syncing state");let lg=await this.__send("syncState");c.__seq_num=0,u=lg}t=u}return c.state=t,c.update?.(d)}if(e.endsWith(w)){let{[R]:d}=this;if(b&&console.log(`[${l}] response message received`),!d[e])throw new Error(`no handlers for ${e}`);d[e].forEach(Y=>{Y(m||o)});return}if(o&&!Array.isArray(o))throw new Error(`[${l}] received payload for ${e} from [${n}] but it was not an array? ${JSON.stringify(o,null,2)}`);let B=e.split(":");b&&console.log(`[${l}] router: stages:`,B);let a=c,h=c.__proto__?.constructor.disallowedCalls??[],W,V;try{let[d]=B;if(B.length===1&&h.includes(d))throw new Error(`Illegal call: ${d} is a protected method`);for(;B.length;){let Y=B.shift();b&&console.log(`checking ${Y}`),a=a[Y]}l==="server"&&o.unshift(this[f])}catch(d){b&&console.error(`cannot resolve ${e} on ${l}`,d),W=d.message}if(!W)try{V=await a.bind(c)(...o)??!0,l===K&&c.browser&&c.setState(c.state)}catch(d){b&&console.error(`function invocation for ${e} failed on ${l}, payload:`,o),b&&console.error(d),W=`Cannot call [[${l}]].${e.replaceAll(":",".")}, function is not defined.`}let S=H(e);b&&console.log(`[${l}] sending ${S}`,{payload:V,error:W}),super.send(JSON.stringify({name:S,payload:V,error:W}))}__on(I,g){let{[R]:c}=this;return c[I]||(c[I]=[]),c[I].push(g),()=>this.__off(I,g)}__off(I,g){let{[R]:c}=this;if(!c[I])return;let l=c[I].indexOf(g);c[I].splice(l,1)}async __send(I,g={},c=1e3){let{[p]:l,[y]:n}=this;return b&&console.log(`[${l}] sending [${I}] to [${n}]:`,g),await new Promise((Z,e)=>{let o=H(I),i=(t=void 0)=>{b&&console.log(`[${l}] cleanup`),this.__off(o,G),i=()=>{},Z(t)},G=t=>i(t);this.__on(o,t=>{b&&console.log(`[${l}] handling response for ${I} from [${n}]:`),G(t)});let s=()=>{b&&console.log(`(raw) sending ${I} from ${l} to ${n}`),super.send(JSON.stringify({name:I,payload:g}))};super.readyState===1?s():super.onopen=s,isFinite(c)&&setTimeout(()=>i(),c)})}},L=class C extends Function{constructor(I,g,c,l=""){return super(),this[p]=g,this[y]=c,this.id=ng(),this.path=l,this.socket=I,new Proxy(this,{get:(n,Z)=>Z==="id"?this.id:Z==="socket"?this.socket:new C(I,g,c,`${l}:${Z}`),apply:async(n,Z,e)=>{b&&console.log(`[SPapply] sending ${this.path.substring(1)} receiver ${this[p]} to ${this[y]}`);let o=await this.socket.upgraded.send(this.path.substring(1),e,this[y]===X?1/0:void 0);if(o instanceof v){let i=[...new Array(e.length)].map((G,s)=>String.fromCharCode(97+s)).join(",");throw b&&console.error(`ERROR calling [[${o.originName}]].${this.path.substring(1).replaceAll(":",".")}(${i}): ${o.message}`),new Error(o.message)}return o}})}};function N(C,I,g,c){return c=U.upgrade(c,g,C,I),c[f]=new L(c,C,I)}var A=!1,T=Symbol();function x(C){return class Q extends C{static get disallowedCalls(){let g=Object.getOwnPropertyNames(Q.prototype);return["constructor","disconnect"].forEach(c=>g.splice(g.indexOf(c),1)),g}constructor(){super();let g=this[T]={},c=new Proxy(g,{get:(l,n)=>g[n],set:()=>{throw new Error("cannot directly assign to state, use setState(update)")}});Object.defineProperty(this,"state",{value:c,writable:!1,configurable:!1}),this.onConnect||(this.onConnect=async()=>{A&&console.log(`[ClientBase] client ${this.state.id} connected.`)}),this.onDisconnect||(this.onDisconnect=async()=>{A&&console.log(`[ClientBase] client ${this.state.id} disconnected.`)}),this.onQuit||(this.onQuit=async()=>{A&&console.log(`[ClientBase] client ${this.state.id} quitting.`)})}setState(g){A&&console.log("[ClientBase] updating state");let c=this[T];Object.entries(g).forEach(([l,n])=>c[l]=n)}connectServerSocket(g){A&&console.log("[ClientBase]  connected to server"),this.server=N(K,F,this,g),this.onConnect()}disconnect(){this.server.socket.close()}}}function E(C){return class j extends C{clients=[];ws=void 0;webserver=void 0;static get disallowedCalls(){let g=Object.getOwnPropertyNames(j.prototype);return g.splice(g.indexOf("constructor"),1),g}constructor(g,c){super(),this.ws=g,this.webserver=c}async connectClientSocket(g){A&&console.log("[ServerBase] client connecting to server...");let c=N(F,K,this,g);A&&console.log("[ServerBase] sending connection id"),c.socket.send(JSON.stringify({name:"handshake:setid",payload:{id:c.id}})),A&&console.log("[ServerBase] adding client to list of known clients"),this.clients.push(c),this.addDisconnectHandling(c,g),this.onConnect(c)}async addDisconnectHandling(g,c){let{clients:l}=this;c.on("close",()=>{let n=l.findIndex(Z=>Z===g);if(n!==-1){let Z=l.splice(n,1)[0];this.onDisconnect(g)}})}async onDisconnect(g){if(super.onDisconnect)return super.onDisconnect(g);A&&console.log(`[ServerBase] client ${g.id} disconnected.`)}async onConnect(g){if(super.onConnect)return super.onConnect(g);A&&console.log(`[ServerBase] client ${g.id} connected.`)}async quit(){await this.onQuit(),this.clients.forEach(g=>g.disconnect()),this.webserver.close(),this.ws.close(),this.teardown()}async onQuit(){if(super.onQuit)return super.onQuit();A&&console.log("[ServerBase] told to quit.")}async teardown(){if(super.teardown)return super.teardown();A&&console.log("[ServerBase] post-quit teardown.")}}}import{createPatch as og}from"rfc6902";var r=!1;function O(C){return class P extends C{browser=void 0;constructor(){super(),this.onBrowserConnect||(this.onBrowserConnect=async g=>{r&&console.log("[WebClientBase] browser connected.")}),this.onBrowserDisconnect||(this.onBrowserDisconnect=async g=>{r&&console.log("[WebClientBase] browser disconnected.")})}static get disallowedCalls(){let g=Object.getOwnPropertyNames(P.prototype).concat(C.disallowedCalls);return["constructor","quit","syncState"].forEach(c=>g.splice(g.indexOf(c),1)),g}connectBrowserSocket(g){this.browser||(this.browser=N(z,X,this,g),this.browser.socket.__seq_num=0,this.setState(this.state),this.onBrowserConnect(this.browser))}disconnectBrowserSocket(){this.onBrowserDisconnect(this.browser),this.browser=void 0}setState(g){if(r&&console.log("[WebClientBase] setState"),super.setState(g),r&&console.log("[WebClientBase] client has browser?",!!this.browser),this.browser){r&&console.log("[WebClientBase] creating diff as part of setState");let c=og(this.__oldState??{},this.state);if(c.length>0){let l={state:c,seq_num:++this.browser.socket.__seq_num,diff:!0};r&&console.log("[WebClientBase] sending diff as part of setState:",l),this.browser.socket.send(JSON.stringify(l))}else r&&console.log("no difference, skipping state sync.")}this.__oldState=JSON.parse(JSON.stringify(this.state))}syncState(){if(this.browser){r&&console.log("[WebClientBase] running syncState (will respond with full state)");let g=JSON.parse(JSON.stringify(this.state));return this.browser.socket.__seq_num=0,r&&console.log("[WebClientBase] responding with full state:",g),g}throw new Error("[WebClientBase] Cannot sync state: no browser attached to client.")}quit(){this.browser&&(this.browser.socket.close(),this.disconnectBrowserSocket()),this.disconnect(),this.onQuit()}}}var J=class{constructor(I){this.owner=I,this.routes={}}addRouteHandler(I,...g){this.routes[I]=g}removeRoute(I){delete this.routes[I]}async handle(I,g,c){let l=this.routes[I];if(!l)return!1;for(let n=0,Z=l.length;n<Z;n++){let e=l[n],o=!0,i=()=>o=!1;try{await e(g,c,i)}catch(G){console.error(G),console.trace();break}if(o)break}return!0}};import ig from"node:fs";import{join as D}from"node:path";var M=atob("LyoqCiAqIFRoaXMgZmlsZSBob3VzZXMgdGhlIGNvcmUgb2YgdGhlIFJQQyBmdW5jdGlvbmFsaXR5LgogKgogKiBUaGUgYFVwZ3JhZGVkU29ja2V0YCBjbGFzcyBpcyBhbiBleHRlbnNpb24gb24gdGhlIFdlYlNvY2tldCBjbGFzcyB0aGF0IGFkZHMKICogY3VzdG9tIG9uL29mZi9zZW5kIG1ldGhvZHMgKGV4cG9zZWQgdGhyb3VnaCBhIHNvY2tldC51cGdyYWRlZCBvYmplY3QpLCBzZXQKICogdXAgdG8gaGFuZGxlIGF1dG9tYXRpYyByZXNwb25zZXMgdG8gY2FsbHMuIEluY29taW5nIFdlYlNvY2tldCBtZXNzYWdlcyBhcmUKICogcm91dGVkIGludG8gdGhlIGByb3V0ZXJgIGZ1bmN0aW9uLCB3aGljaCBoYXMgYmVoYXZpb3VyIHRhaWxvcmVkIHRvIHNwZWNpZmljCiAqIG9yaWdpbnMsIGFuZCBtYWtlcyBzdXJlIHRoYXQgbWVzc2FnZXMgYXJlIGFsd2F5cyByZXNwb25kZWQgdG8uCiAqCiAqIFRoZSBgX19zZW5kYCBmdW5jdGlvbiwgaW4gdHVybiwgZG9lc24ndCBqdXN0IHNlbmQgZGF0YSBvdmVyIHRvIGEgcmVtb3RlLCBidXQKICogYWxzbyB3YWl0cyBmb3IgdGhhdCByZW1vdGUncyA6cmVzcG9uc2UgbWVzc2FnZSwgdXNpbmcgUHJvbWlzZXMgdG8gbWFrZQogKiBzdXJlIHRoYXQgYW55b25lIGNhbiBgYXdhaXQgc29ja2V0LnVwZ3JhZGVkLnNlbmQoLi4uKWAgYW5kIGdldCBhIHJlc3BvbnNlCiAqIG9uY2UgdGhhdCByZXNwb25zZSBoYXMgYmVlbiBzZW50IGJhY2suIEFzIGZhciBhcyBjYWxsaW5nIGNvZGUgaXMgY29uY2VybmVkLAogKiB0aGlzIGlzIGEgbm9ybWFsIGFzeW5jIGNhbGwsIGFuZCB0aGUgZmFjdCB0aGF0IG5ldHdvcmsgdHJhbnNwb3J0IGhhcHBlbmVkCiAqIGlzIGVudGlyZWx5IGlycmVsZXZhbnQuIENhbGxlcnMgc2hvdWxkIG5vdCBjYXJlLgogKgogKiBUaGUgYFNvY2tldFByb3h5YCBpcyBhIGNsZXZlciBsaXR0bGUgUHJveHkgb2JqZWN0IHRoYXQgZXh0ZW5kcyB0aGUgRnVuY3Rpb24KICogYnVpbHQtaW4sIHdoaWNoIGFsbG93cyB1cyB0byBjcmVhdGUgYSByZWN1cnNpdmUgb2JqZWN0IHdoZXJlIGFueSBwcm9wZXJ0eQogKiBvbiBpdCBpcyBhIHZhbGlkIGZ1bmN0aW9uIHRvIGNhbGwsIGFuZCBkb2luZyBzbyB3aWxsIHNlbmQgdGhlIGNvcnJlc3BvbmRpbmcKICogY2FsbCBjaGFpbiBvdmVyIHRvIHRoZSByZW1vdGUgZm9yIGV4ZWN1dGlvbiBhbmQgcmVzcG9uc2UgbWVzc2FnaW5nLiBUaGlzIHdheSwKICogd2UgZG9uJ3QgbmVlZCB0byBwZXJmb3JtIGFueSAid2hpY2ggZnVuY3Rpb25zIGFyZSBzdXBwb3J0ZWQiLCB3ZSBjYW4ganVzdCBwcm94eQogKiB0aGUgY2FsbCBvdmVyIHRoZSBuZXR3b3JrLCBpZiBpdCBleGlzdHMsIGl0IHJ1bnMsIGlmIGl0IGRvZXNuJ3QsIHRoZW4gd2UnbGwKICogZ2V0IGEgcmVzdWx0IGJhY2sgd2l0aCBhbiBgZXJyb3JgIG1lc3NhZ2UgdGhhdCB3ZSBjYW4gdHVybiBpbnRvIGEgbG9jYWwgdGhyb3cuCiAqLwoKCmNvbnN0IEJST1dTRVIgPSAiYnJvd3NlciI7CmNvbnN0IENMSUVOVCA9ICJjbGllbnQiOwoKY2xhc3MgUlBDRXJyb3IgewogIGNvbnN0cnVjdG9yKG9yaWdpbk5hbWUsIG1lc3NhZ2UpIHsKICAgIHRoaXMub3JpZ2luTmFtZSA9IG9yaWdpbk5hbWU7CiAgICB0aGlzLm1lc3NhZ2UgPSBtZXNzYWdlOwogIH0KfQoKY29uc3QgREVCVUcgPSBmYWxzZTsKCi8vIGltcG9ydGluZyB0aGUgdXVpZCBwYWNrYWdlIGlzIHdheSB0b28gZXhwZW5zaXZlIGZvciB3aGF0IHdlIG5lZWQgaGVyZQpmdW5jdGlvbiB1dWlkKCkgewogIGNvbnN0IG5vdyA9IERhdGUubm93KCkudG9TdHJpbmcoMTYpOwogIGNvbnN0IHJkbSA9ICgoMWU2ICogTWF0aC5yYW5kb20oKSkgfCAwKS50b1N0cmluZygxNik7CiAgcmV0dXJuIGAke25vd30tJHtyZG19YDsKfQoKLy8gcmVzcG9uc2VzIHNob3VsZCBhbHdheXMgYmUgInRoZSBldmVudCBuYW1lLCB3aXRoIDpyZXNwb25zZSBhZGRlZCIKZXhwb3J0IGNvbnN0IFJFU1BPTlNFX1NVRkZJWCA9IGA6cmVzcG9uc2VgOwpleHBvcnQgY29uc3QgZ2V0UmVzcG9uc2VOYW1lID0gKGV2ZW50TmFtZSkgPT4gYCR7ZXZlbnROYW1lfSR7UkVTUE9OU0VfU1VGRklYfWA7CgovLyB1c2Ugc3ltYm9scyBzbyB3ZSBkb24ndCBwb2xsdXRlIHRoZSBzb2NrZXQgcHJvdG90eXBlCmNvbnN0IE9SSUdJTiA9IFN5bWJvbChgb3JpZ2luYCk7CmNvbnN0IFBST1hZID0gU3ltYm9sKGBwcm94eWApOwpjb25zdCBSRUNFSVZFUiA9IFN5bWJvbChgcmVjZWl2ZXJgKTsKY29uc3QgUkVNT1RFID0gU3ltYm9sKGByZW1vdGVgKTsKY29uc3QgSEFORExFUlMgPSBTeW1ib2woYGhhbmRsZXJzYCk7CgovKioKICogLi4uZG8gZG9jcyBnbyBoZXJlPwogKi8KY2xhc3MgVXBncmFkZWRTb2NrZXQgZXh0ZW5kcyBXZWJTb2NrZXQgewogIFtPUklHSU5dID0gdW5kZWZpbmVkOyAvLyB0aGUgc29ja2V0IG93bmVyIHdobyBpbnZva2VkIHRoZSB1cGdyYWRlLiBTZWUgdXBncmFkZSgpCiAgW1BST1hZXSA9IHVuZGVmaW5lZDsgLy8gdGhlIHByb3h5IG9iamVjdCBhc3NvY2lhdGVkIHdpdGggdGhpcyBzb2NrZXQKICBbUkVDRUlWRVJdID0gYGA7IC8vIG5hbWUgb2YgdGhlIHJlY2VpdmluZyBvYmplY3QKICBbUkVNT1RFXSA9IGBgOyAvLyBuYW1lIG9mIHRoZSByZW1vdGUgb2JqZWN0CiAgW0hBTkRMRVJTXSA9IHt9OyAvLyB0aGUgbGlzdCBvZiBldmVudCBoYW5kbGVycy4gU2VlIHVwZ3JhZGUoKQoKICAvLyBleHBsaWNpdGx5IGZvcmJpZCB0aGUgY29uc3RydWN0b3IgZnJvbSBiZWluZyB1c2VkLgogIC8vIEB0cy1pZ25vcmU6IHdlIGRvbid0IG5lZWQgdG8gY2FsbCBzdXBlcigpIGlmIHdlIGVycm9yIG91dC4KICBjb25zdHJ1Y3RvcigpIHsKICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgIkNhbm5vdCBjcmVhdGUgVXBncmFkZWRTb2NrZXQgaW5zdGFuY2VzLiBVc2UgVXBncmFkZWRTb2NrZXQudXBncmFkZShuYW1lLCBvcmlnaW4sIHNvY2tldCkgaW5zdGVhZC4iLAogICAgKTsKICB9CgogIC8vIHVwZ3JhZGUgYSBzb2NrZXQgZnJvbSBwbGFpbiBXZWJTb2NrZXQgdG8gdGhpcyBjbGFzcyBpbnN0ZWFkLgogIHN0YXRpYyB1cGdyYWRlKHNvY2tldCwgb3JpZ2luLCByZWNlaXZlciwgcmVtb3RlKSB7CiAgICBpZiAoc29ja2V0IGluc3RhbmNlb2YgVXBncmFkZWRTb2NrZXQpIHJldHVybiBzb2NrZXQ7CiAgICAvLyB1cGRhdGUgdGhlIHByb3RvdHlwZSBiaW5kaW5nCiAgICBPYmplY3Quc2V0UHJvdG90eXBlT2Yoc29ja2V0LCBVcGdyYWRlZFNvY2tldC5wcm90b3R5cGUpOwogICAgLy8gbWFrZSBzdXJlIHRoYXQgbWVzc2FnZXMgZ28gdGhyb3VnaCB0aGUgcm91dGVyOgogICAgc29ja2V0W09SSUdJTl0gPSBvcmlnaW47CiAgICBzb2NrZXRbUkVDRUlWRVJdID0gcmVjZWl2ZXI7CiAgICBzb2NrZXRbUkVNT1RFXSA9IHJlbW90ZTsKICAgIHNvY2tldFtIQU5ETEVSU10gPSB7fTsKICAgIGNvbnN0IG1lc3NhZ2VSb3V0ZXIgPSBzb2NrZXQucm91dGVyLmJpbmQoc29ja2V0KTsKICAgIGlmIChzb2NrZXQub24pIHsKICAgICAgc29ja2V0Lm9uKGBtZXNzYWdlYCwgbWVzc2FnZVJvdXRlcik7CiAgICB9IGVsc2UgewogICAgICBzb2NrZXQub25tZXNzYWdlID0gbWVzc2FnZVJvdXRlcjsKICAgIH0KCiAgICAvLyBjb252ZW5pZW5jZSByZXR1cm4uCiAgICByZXR1cm4gc29ja2V0OwogIH0KCiAgLy8gU3BlY2lhbCBhY2Nlc3NvciBmb3IgdXBncmFkZWQgc29ja2V0IGZ1bmN0aW9ucywKICBnZXQgdXBncmFkZWQoKSB7CiAgICBpZiAoIXRoaXMuX191cGdyYWRlZCkgewogICAgICB0aGlzLl9fdXBncmFkZWQgPSB7CiAgICAgICAgb246ICguLi5hcmdzKSA9PiB0aGlzLl9fb24oLi4uYXJncyksCiAgICAgICAgb2ZmOiAoLi4uYXJncykgPT4gdGhpcy5fX29mZiguLi5hcmdzKSwKICAgICAgICBzZW5kOiAoLi4uYXJncykgPT4gdGhpcy5fX3NlbmQoLi4uYXJncyksCiAgICAgIH07CiAgICB9CiAgICByZXR1cm4gdGhpcy5fX3VwZ3JhZGVkOwogIH0KCiAgLy8gbWVzc2FnZSByb3V0ZXIgc3BlY2lmaWNhbGx5IGZvciB0aGUgbWVzc2FnZSBmb3JtYXQgdXNlZCBieSB0aGUgc29ja2V0bGVzcyBjb2RlLgogIGFzeW5jIHJvdXRlcihtZXNzYWdlLCBmb3JjZWQgPSBmYWxzZSkgewogICAgY29uc3QgeyBbT1JJR0lOXTogb3JpZ2luLCBbUkVDRUlWRVJdOiByZWNlaXZlciwgW1JFTU9URV06IHJlbW90ZSB9ID0gdGhpczsKCiAgICAvLyBBbnkgY2FsbHMgZnJvbSB0aGUgYnJvd3NlciB0byB0aGUgd2ViY2xpZW50IGFyZSB0aGF0J3MgYWxyZWFkeSBoYW5kbGVkCiAgICAvLyBieSB0aGUgd2Vic29ja2V0IGRpcmVjdGx5IChzZWUgdGhlIGNyZWF0ZVdlYkNsaWVudCBmdW5jdGlvbiBpbiBpbmRleC5qcywKICAgIC8vIGluIHRoZSB3cy5vbihgY29ubmVjdGlvbmAsIC4uLikgYmxvY2spLCBzbyB3ZSBuZWVkIHRvIG1ha2Ugc3VyZSB0byBub3QKICAgIC8vIHRyeSB0byAiZG91YmxlLWhhbmRsZSIgdGhhdDoKICAgIGlmIChyZW1vdGUgPT09IEJST1dTRVIgJiYgIWZvcmNlZCkgewogICAgICByZXR1cm47CiAgICB9CgogICAgLy8gYnJvd3NlciB3ZWJzb2NrZXQ/IElmIHNvLCB1bndyYXAgdGhlIGRhdGEKICAgIGlmIChtZXNzYWdlLnNyY0VsZW1lbnQpIHsKICAgICAgbWVzc2FnZSA9IG1lc3NhZ2UuZGF0YTsKICAgIH0KCiAgICBsZXQgZGF0YTsKCiAgICB0cnkgewogICAgICBkYXRhID0gSlNPTi5wYXJzZShtZXNzYWdlKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgcmV0dXJuIGNvbnNvbGUuZXJyb3IoYENvdWxkIG5vdCBwYXJzZSB3ZWJzb2NrZXQgZGF0YTogJHttZXNzYWdlfWApOwogICAgfQoKICAgIGNvbnN0IHsgbmFtZTogZXZlbnROYW1lLCBwYXlsb2FkLCBlcnJvcjogZXJyb3JNc2csIGRpZmYsIHNlcV9udW0gfSA9IGRhdGE7CiAgICBsZXQgeyBzdGF0ZSB9ID0gZGF0YTsKICAgIGxldCB0aHJvd2FibGUgPSBlcnJvck1zZyA/IG5ldyBSUENFcnJvcihyZWNlaXZlciwgZXJyb3JNc2cpIDogdW5kZWZpbmVkOwoKICAgIGlmIChERUJVRykKICAgICAgY29uc29sZS5sb2coYFske3JlY2VpdmVyfV0vWyR7cmVtb3RlfV0gcm91dGVyIHJ1bm5pbmcgZ2l2ZW46YCwgewogICAgICAgIGV2ZW50TmFtZSwKICAgICAgICBwYXlsb2FkLAogICAgICAgIGVycm9yTXNnLAogICAgICAgIHN0YXRlLAogICAgICAgIGRpZmYsCiAgICAgICAgc2VxX251bSwKICAgICAgfSk7CgogICAgLy8gQ2xpZW50LXN0YXRlIHN5bmNocm9uaXphdGlvbiBtZWNoYW5pc20gZm9yIHRoZSBicm93c2VyOgogICAgaWYgKHN0YXRlICYmIHJlY2VpdmVyID09PSBCUk9XU0VSKSB7CiAgICAgIGlmIChERUJVRykgY29uc29sZS5sb2coYGhhbmRsaW5nIHN0YXRlIHVwZGF0ZSBpbiB0aGUgYnJvd3NlcmAsIHN0YXRlKTsKICAgICAgaWYgKERFQlVHKSBjb25zb2xlLmxvZyhgb3JpZ2luIG9iamVjdDpgLCB7IG9yaWdpbiB9KTsKICAgICAgY29uc3QgcHJldlN0YXRlID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShvcmlnaW4uc3RhdGUpKTsKICAgICAgaWYgKGRpZmYpIHsKICAgICAgICBpZiAoREVCVUcpIGNvbnNvbGUubG9nKGByZWNlaXZlZCBkaWZmYCwgc3RhdGUpOwogICAgICAgIGNvbnN0IHBhdGNoID0gc3RhdGU7CiAgICAgICAgbGV0IHRhcmdldDsKICAgICAgICAvLyB2ZXJpZnkgd2UncmUgc3RpbGwgaW4gc3luYyBieSBjb21wYXJpbmcgbWVzc2FnaW5nIHNlcXVlbmNlIG51bWJlcnMKICAgICAgICBpZiAoc2VxX251bSA9PT0gb3JpZ2luLl9fc2VxX251bSArIDEpIHsKICAgICAgICAgIG9yaWdpbi5fX3NlcV9udW0gPSBzZXFfbnVtOwogICAgICAgICAgdGFyZ2V0ID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShwcmV2U3RhdGUpKTsKICAgICAgICAgIGlmIChERUJVRykgY29uc29sZS5sb2coYGFwcGx5aW5nIHBhdGNoIHRvYCwgdGFyZ2V0KTsKICAgICAgICAgIC8vIEB0cy1pZ25vcmU6IHRoaXMgb25seSBydW5zIGluIHRoZSBicm93c2VyLCB3aGVyZSByZmM2OTAyIGlzIGEgZ2xvYmFsLgogICAgICAgICAgcmZjNjkwMi5hcHBseVBhdGNoKHRhcmdldCwgcGF0Y2gpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBpZiB3ZSBnZXQgaGVyZSwgd2UncmUgbm90IGluIHN5bmMsIGFuZCB3ZSBuZWVkIHRvIHJlcXVlc3QgYSBmdWxsCiAgICAgICAgICAvLyBzdGF0ZSBvYmplY3QgaW5zdGVhZCBvZiB0cnlpbmcgdG8gYXBwbHkgZGlmZmVyZW50aWFsIHVwZGF0ZXMuCiAgICAgICAgICBpZiAoREVCVUcpIGNvbnNvbGUubG9nKGBzZXFfbnVtIG1pc21hdGNoLCBzeW5jaW5nIHN0YXRlYCk7CiAgICAgICAgICBjb25zdCBmdWxsU3RhdGUgPSBhd2FpdCB0aGlzLl9fc2VuZChgc3luY1N0YXRlYCk7CiAgICAgICAgICBvcmlnaW4uX19zZXFfbnVtID0gMDsKICAgICAgICAgIHRhcmdldCA9IGZ1bGxTdGF0ZTsKICAgICAgICB9CiAgICAgICAgc3RhdGUgPSB0YXJnZXQ7CiAgICAgIH0KICAgICAgLy8gUnVuIHRoZSB1cGRhdGUgd2l0aCB0aGUgbmV3IHN0YXRlIGFzIGFyZ3VtZW50IGZpcnN0LCB0aGVuCiAgICAgIC8vIG92ZXJ3cml0ZSB0aGUgb2xkIHN0YXRlIHdpdGggdGhlIG5ldyBzdGF0ZSBhZnRlciB0aGUgdXBkYXRlLgogICAgICBvcmlnaW4uc3RhdGUgPSBzdGF0ZTsKICAgICAgcmV0dXJuIG9yaWdpbi51cGRhdGU/LihwcmV2U3RhdGUpOwogICAgfQoKICAgIC8vIElmIHRoaXMgaXMgYSByZXNwb25zZSBtZXNzYWdlLCBydW4gdGhlIGBvbmAgaGFuZGxlciBmb3IgdGhhdC4KICAgIGlmIChldmVudE5hbWUuZW5kc1dpdGgoUkVTUE9OU0VfU1VGRklYKSkgewogICAgICBjb25zdCB7IFtIQU5ETEVSU106IGhhbmRsZXJzIH0gPSB0aGlzOwogICAgICBpZiAoREVCVUcpIGNvbnNvbGUubG9nKGBbJHtyZWNlaXZlcn1dIHJlc3BvbnNlIG1lc3NhZ2UgcmVjZWl2ZWRgKTsKICAgICAgaWYgKCFoYW5kbGVyc1tldmVudE5hbWVdKSB0aHJvdyBuZXcgRXJyb3IoYG5vIGhhbmRsZXJzIGZvciAke2V2ZW50TmFtZX1gKTsKICAgICAgaGFuZGxlcnNbZXZlbnROYW1lXS5mb3JFYWNoKChoYW5kbGVyKSA9PiB7CiAgICAgICAgaGFuZGxlcih0aHJvd2FibGUgPyB0aHJvd2FibGUgOiBwYXlsb2FkKTsKICAgICAgfSk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBJZiB3ZSBnZXQgaGVyZSwgdGhpcyBpcyBhIHJlYWwgUlBDIGNhbGwgcmF0aGVyIHRoYW4gYSByZXNwb25zZSBvciBzdGF0ZSB1cGRhdGUuCiAgICBpZiAocGF5bG9hZCAmJiAhQXJyYXkuaXNBcnJheShwYXlsb2FkKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgYFske3JlY2VpdmVyfV0gcmVjZWl2ZWQgcGF5bG9hZCBmb3IgJHtldmVudE5hbWV9IGZyb20gWyR7cmVtb3RlfV0gYnV0IGl0IHdhcyBub3QgYW4gYXJyYXk/ICR7SlNPTi5zdHJpbmdpZnkoCiAgICAgICAgICBwYXlsb2FkLAogICAgICAgICAgbnVsbCwKICAgICAgICAgIDIsCiAgICAgICAgKX1gLAogICAgICApOwogICAgfQoKICAgIC8vIElmIGl0J3MgYSByZXF1ZXN0IG1lc3NhZ2UsIHJlc29sdmUgaXQgdG8gYSBmdW5jdGlvbiBjYWxsIGFuZCAicmV0dXJuIgogICAgLy8gdGhlIHZhbHVlIGJ5IHNlbmRpbmcgYSA6cmVzcG9uc2UgbWVzc2FnZSBvdmVyIHRoZSB3ZWJzb2NrZXQgaW5zdGVhZC4KICAgIGNvbnN0IHN0YWdlcyA9IGV2ZW50TmFtZS5zcGxpdChgOmApOwogICAgaWYgKERFQlVHKSBjb25zb2xlLmxvZyhgWyR7cmVjZWl2ZXJ9XSByb3V0ZXI6IHN0YWdlczpgLCBzdGFnZXMpOwoKICAgIGxldCBjYWxsYWJsZSA9IG9yaWdpbjsKICAgIGxldCBmb3JiaWRkZW4gPSBvcmlnaW4uX19wcm90b19fPy5jb25zdHJ1Y3Rvci5kaXNhbGxvd2VkQ2FsbHMgPz8gW107CiAgICBsZXQgZXJyb3IgPSB1bmRlZmluZWQ7CiAgICBsZXQgcmVzcG9uc2UgPSB1bmRlZmluZWQ7CgogICAgLy8gRmluZCB0aGUgYWN0dWFsIGZ1bmN0aW9uIHRvIGNhbGwKICAgIHRyeSB7CiAgICAgIGNvbnN0IFtmaXJzdF0gPSBzdGFnZXM7CiAgICAgIGlmIChzdGFnZXMubGVuZ3RoID09PSAxICYmIGZvcmJpZGRlbi5pbmNsdWRlcyhmaXJzdCkpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYElsbGVnYWwgY2FsbDogJHtmaXJzdH0gaXMgYSBwcm90ZWN0ZWQgbWV0aG9kYCk7CiAgICAgIH0KICAgICAgd2hpbGUgKHN0YWdlcy5sZW5ndGgpIHsKICAgICAgICBjb25zdCBzdGFnZSA9IHN0YWdlcy5zaGlmdCgpOwogICAgICAgIGlmIChERUJVRykgY29uc29sZS5sb2coYGNoZWNraW5nICR7c3RhZ2V9YCk7CiAgICAgICAgY2FsbGFibGUgPSBjYWxsYWJsZVtzdGFnZV07CiAgICAgIH0KICAgICAgLy8gSWYgdGhpcyBjb2RlIHJ1bnMgb24gdGhlIHNlcnZlciwgdGhlIGZ1bmN0aW9uIG5lZWRzIHRvIGJlCiAgICAgIC8vIGNhbGxlZCB3aXRoIHRoZSBjbGllbnQgcHJveHkgYXMgZmlyc3QgYXJndW1lbnQuCiAgICAgIGlmIChyZWNlaXZlciA9PT0gYHNlcnZlcmApIHBheWxvYWQudW5zaGlmdCh0aGlzW1BST1hZXSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIC8vICJmdW5jdGlvbiBub3QgZm91bmQiIGRvZXNuJ3QgY291bnQgYXMgZXJyb3IgImhlcmUiLgogICAgICAvLyBJbnN0ZWFkLCB3ZSBzZW5kIHRoYXQgYmFjayB0byB0aGUgY2FsbGVyLgogICAgICBpZiAoREVCVUcpIGNvbnNvbGUuZXJyb3IoYGNhbm5vdCByZXNvbHZlICR7ZXZlbnROYW1lfSBvbiAke3JlY2VpdmVyfWAsIGUpOwogICAgICBlcnJvciA9IGUubWVzc2FnZTsKICAgIH0KCiAgICAvLyBSZXNvbHZlIHRoZSBmdW5jdGlvbiBhbmQgdGhlbiBzZW5kIHRoZSByZXN1bHQgYXMgOnJlc3BvbnNlLCBtYWtpbmcKICAgIC8vIHN1cmUgdG8gdGFrZSBpbnRvIGFjY291bnQgdGhhdCBhIGNhbGwgaXRzZWxmIG1pZ2h0IHRocm93LgogICAgaWYgKCFlcnJvcikgewogICAgICB0cnkgewogICAgICAgIHJlc3BvbnNlID0gKGF3YWl0IGNhbGxhYmxlLmJpbmQob3JpZ2luKSguLi5wYXlsb2FkKSkgPz8gdHJ1ZTsKICAgICAgICAvLyBJZiB0aGlzIGlzIGEgd2ViY2xpZW50LCBhbmQgdGhlcmUgaXMgYSBicm93c2VyIGNvbm5lY3RlZCwKICAgICAgICAvLyBhbHNvIG1ha2Ugc3VyZSB0byB0cmlnZ2VyIGEgc3RhdGUgc3luYywgc28gdGhhdCBjbGllbnQgY29kZQogICAgICAgIC8vIGRvZXMgbm90IG5lZWQgdG8gaW5jbHVkZSBzZXRTdGF0ZSBjYWxscyBhbGwgb3ZlciB0aGUgcGxhY2UuCiAgICAgICAgaWYgKHJlY2VpdmVyID09PSBDTElFTlQgJiYgb3JpZ2luLmJyb3dzZXIpIHsKICAgICAgICAgIG9yaWdpbi5zZXRTdGF0ZShvcmlnaW4uc3RhdGUpOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGlmIChERUJVRykKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoCiAgICAgICAgICAgIGBmdW5jdGlvbiBpbnZvY2F0aW9uIGZvciAke2V2ZW50TmFtZX0gZmFpbGVkIG9uICR7cmVjZWl2ZXJ9LCBwYXlsb2FkOmAsCiAgICAgICAgICAgIHBheWxvYWQsCiAgICAgICAgICApOwogICAgICAgIGlmIChERUJVRykgY29uc29sZS5lcnJvcihlKTsKICAgICAgICBlcnJvciA9IGBDYW5ub3QgY2FsbCBbWyR7cmVjZWl2ZXJ9XV0uJHtldmVudE5hbWUucmVwbGFjZUFsbCgKICAgICAgICAgIGA6YCwKICAgICAgICAgIGAuYCwKICAgICAgICApfSwgZnVuY3Rpb24gaXMgbm90IGRlZmluZWQuYDsKICAgICAgfQogICAgfQoKICAgIC8vIFNlbmQgb2ZmIGEgcmVzcG9uc2UgbWVzc2FnZSB3aXRoIGVpdGhlciB0aGUgcmVzdWx0LCBvciB0aGUgZXJyb3IuCiAgICBjb25zdCByZXNwb25zZU5hbWUgPSBnZXRSZXNwb25zZU5hbWUoZXZlbnROYW1lKTsKICAgIGlmIChERUJVRykKICAgICAgY29uc29sZS5sb2coYFske3JlY2VpdmVyfV0gc2VuZGluZyAke3Jlc3BvbnNlTmFtZX1gLCB7CiAgICAgICAgcGF5bG9hZDogcmVzcG9uc2UsCiAgICAgICAgZXJyb3IsCiAgICAgIH0pOwogICAgc3VwZXIuc2VuZCgKICAgICAgSlNPTi5zdHJpbmdpZnkoeyBuYW1lOiByZXNwb25zZU5hbWUsIHBheWxvYWQ6IHJlc3BvbnNlLCBlcnJvciB9KSwKICAgICk7CiAgfQoKICAvKioKICAgKiB0aGlzLnVwZ3JhZGVkLm9uKCkgbWFkZSB0byB3b3JrIGxpa2UgLmFkZEV2ZW50TGlzdGVuZXIoKQogICAqLwogIF9fb24oZXZlbnROYW1lLCBoYW5kbGVyKSB7CiAgICBjb25zdCB7IFtIQU5ETEVSU106IGhhbmRsZXJzIH0gPSB0aGlzOwogICAgaWYgKCFoYW5kbGVyc1tldmVudE5hbWVdKSBoYW5kbGVyc1tldmVudE5hbWVdID0gW107CiAgICBoYW5kbGVyc1tldmVudE5hbWVdLnB1c2goaGFuZGxlcik7CiAgICAvLyByZXR1cm4gdGhlIGNvcnJlc3BvbmRpbmcgIm9mZiIgZnVuY3Rpb24sIGZvciBjb252ZW5pZW5jZS4KICAgIHJldHVybiAoKSA9PiB0aGlzLl9fb2ZmKGV2ZW50TmFtZSwgaGFuZGxlcik7CiAgfQoKICAvKioKICAgKiB0aGlzLnVwZ3JhZGVkLm9mZigpIG1hZGUgdG8gd29yayBsaWtlIC5yZW1vdmVFdmVudExpc3RlbmVyKCkKICAgKi8KICBfX29mZihldmVudE5hbWUsIGhhbmRsZXIpIHsKICAgIGNvbnN0IHsgW0hBTkRMRVJTXTogaGFuZGxlcnMgfSA9IHRoaXM7CiAgICBpZiAoIWhhbmRsZXJzW2V2ZW50TmFtZV0pIHJldHVybjsKICAgIGNvbnN0IHBvcyA9IGhhbmRsZXJzW2V2ZW50TmFtZV0uaW5kZXhPZihoYW5kbGVyKTsKICAgIGhhbmRsZXJzW2V2ZW50TmFtZV0uc3BsaWNlKHBvcywgMSk7CiAgfQoKICAvKioKICAgKiBBZGQgYSBwcm9taXNlLWJhc2VkIGVtaXQvcmVjZWl2ZSB0byB0aGUgc29ja2V0LCBzbyB0aGF0IGNhbGxpbmcgY29kZSBjYW4gYGF3YWl0YCB0aGUgcmVzcG9uc2UuCiAgICoKICAgKiBOb3RlIHRoYXQgdGhlcmUgaXMgYW4gb3B0aW9uYWwgdGhpcmQgYXJndW1lbnQgYHRpbWVvdXRgIHRoYXQgY2FuIGJlIHVzZWQgdG8gc2F5IGhvdyBsb25nIHRoZQogICAqIGVtaXQgc2hvdWxkIHdhaXQgYmVmb3JlIGRlY2lkaW5nIHRoZXJlIGlzIG5vIHJlc3BvbnNlIGZvcnRoY29taW5nIGFuZCB0byBjbGVhbiB1cCB0aGUgZXZlbnQKICAgKiBsaXN0ZW5lciBmb3IgdGhhdCByZXNwb25zZS4gVGhlIGRlZmF1bHQgdGltZW91dCBpcyAxMDAwbXMuCiAgICovCiAgYXN5bmMgX19zZW5kKGV2ZW50TmFtZSwgZGF0YSA9IHt9LCB0aW1lb3V0ID0gMTAwMCkgewogICAgY29uc3QgeyBbUkVDRUlWRVJdOiByZWNlaXZlciwgW1JFTU9URV06IHJlbW90ZSB9ID0gdGhpczsKICAgIGlmIChERUJVRykKICAgICAgY29uc29sZS5sb2coYFske3JlY2VpdmVyfV0gc2VuZGluZyBbJHtldmVudE5hbWV9XSB0byBbJHtyZW1vdGV9XTpgLCBkYXRhKTsKICAgIHJldHVybiBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgIGNvbnN0IHJlc3BvbnNlTmFtZSA9IGdldFJlc3BvbnNlTmFtZShldmVudE5hbWUpOwoKICAgICAgLy8gY2xlYW51cCBmdW5jdGlvbiBmb3IgdGhlIGV2ZW50IGxpc3RlbmVyCiAgICAgIGxldCBjbGVhbnVwID0gKGRhdGEgPSB1bmRlZmluZWQpID0+IHsKICAgICAgICBpZiAoREVCVUcpIGNvbnNvbGUubG9nKGBbJHtyZWNlaXZlcn1dIGNsZWFudXBgKTsKICAgICAgICAvLyBjbGVhbiB1cCBhbmQgYmVjb21lIGEgbm9vcCBzbyB3ZSBjYW4ndCBiZSByZXRyaWdnZXJlZC4KICAgICAgICB0aGlzLl9fb2ZmKHJlc3BvbnNlTmFtZSwgaGFuZGxlcik7CiAgICAgICAgY2xlYW51cCA9ICgpID0+IHt9OwogICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgIH07CgogICAgICAvLyBJbiBvcmRlciB0byByZXNvbHZlIHRoZSBQcm9taXNlLCB3ZSB3aWxsIGJlIGxpc3RlbmluZwogICAgICAvLyBmb3IgdGhhdCBldmVudE5hbWU6cmVzcG9uc2UsIGFuZCB3aGVuIHdlIHJlY2VpdmUgaXQsCiAgICAgIC8vIHdlJ2xsIGltbWVkaWF0ZWx5IFNUT1AgbGlzdGVuaW5nIGZvciBzaW1pbGFyIHJlc3BvbnNlcwogICAgICAvLyBiZWNhdXNlIHdlIG5vIGxvbmdlciBjYXJlLgogICAgICBjb25zdCBoYW5kbGVyID0gKGRhdGEpID0+IGNsZWFudXAoZGF0YSk7CgogICAgICAvLyBGaXJzdCwgbWFrZSBzdXJlIHdlJ3JlIHJlYWR5IHRvIHJlY2VpdmUgdGhlIHJlc3BvbnNlLi4uCiAgICAgIHRoaXMuX19vbihyZXNwb25zZU5hbWUsIChkYXRhKSA9PiB7CiAgICAgICAgaWYgKERFQlVHKQogICAgICAgICAgY29uc29sZS5sb2coCiAgICAgICAgICAgIGBbJHtyZWNlaXZlcn1dIGhhbmRsaW5nIHJlc3BvbnNlIGZvciAke2V2ZW50TmFtZX0gZnJvbSBbJHtyZW1vdGV9XTpgLAogICAgICAgICAgKTsKICAgICAgICBoYW5kbGVyKGRhdGEpOwogICAgICB9KTsKCiAgICAgIC8vIEFuZCB0aGVuLCBzZW5kIHRoZSBldmVudCBvZmYgdG8gdGhlIGNsaWVudC4KICAgICAgY29uc3Qgc2VuZEV2ZW50ID0gKCkgPT4gewogICAgICAgIGlmIChERUJVRykKICAgICAgICAgIGNvbnNvbGUubG9nKAogICAgICAgICAgICBgKHJhdykgc2VuZGluZyAke2V2ZW50TmFtZX0gZnJvbSAke3JlY2VpdmVyfSB0byAke3JlbW90ZX1gLAogICAgICAgICAgKTsKICAgICAgICBzdXBlci5zZW5kKAogICAgICAgICAgSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgICBuYW1lOiBldmVudE5hbWUsCiAgICAgICAgICAgIHBheWxvYWQ6IGRhdGEsCiAgICAgICAgICB9KSwKICAgICAgICApOwogICAgICB9OwoKICAgICAgLy8gV2UgbWF5IGJlIHRyeWluZyB0byBzZW5kIGJlZm9yZSB0aGUgc29ja2V0IGlzIG9wZW4gaW4gYnJvd3NlciBsYW5kLAogICAgICAvLyBzbyBpZiB0aGUgc29ja2V0J3Mgbm90IHJlYWR5LCAicXVldWUiIHRoZSBldmVudCB0byBmaXJlIG9uIG9wZW4uCiAgICAgIGlmIChzdXBlci5yZWFkeVN0YXRlID09PSAxKSBzZW5kRXZlbnQoKTsKICAgICAgZWxzZSBzdXBlci5vbm9wZW4gPSBzZW5kRXZlbnQ7CgogICAgICAvLyBBbmQgbWFrZSBzdXJlIHRoYXQgaWYgbm8gcmVzcG9uc2UgaGFzIG9jY3VycmVkIHdpdGhpbgogICAgICAvLyBgdGltZW91dGAgbWlsbGlzZWNvbmRzLCB3ZSBjbGVhbiB1cCB0aGUgbGlzdGVuZXIuCiAgICAgIGlmIChpc0Zpbml0ZSh0aW1lb3V0KSkgewogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gY2xlYW51cCgpLCB0aW1lb3V0KTsKICAgICAgfQogICAgfSk7CiAgfQp9CgovKioKICogQSBzb2NrZXQgcHJveHkgZm9yIFJQQyBwdXJwb3Nlcy4KICovCmNsYXNzIFNvY2tldFByb3h5IGV4dGVuZHMgRnVuY3Rpb24gewogIGNvbnN0cnVjdG9yKHNvY2tldCwgcmVjZWl2ZXIsIHJlbW90ZSwgcGF0aCA9IGBgKSB7CiAgICBzdXBlcigpOwogICAgdGhpc1tSRUNFSVZFUl0gPSByZWNlaXZlcjsKICAgIHRoaXNbUkVNT1RFXSA9IHJlbW90ZTsKICAgIHRoaXMuaWQgPSB1dWlkKCk7CiAgICB0aGlzLnBhdGggPSBwYXRoOwogICAgdGhpcy5zb2NrZXQgPSBzb2NrZXQ7CiAgICByZXR1cm4gbmV3IFByb3h5KHRoaXMsIHsKICAgICAgZ2V0OiAoXywgcHJvcCkgPT4gewogICAgICAgIGlmIChwcm9wID09PSAiaWQiKSByZXR1cm4gdGhpcy5pZDsKICAgICAgICBpZiAocHJvcCA9PT0gInNvY2tldCIpIHJldHVybiB0aGlzLnNvY2tldDsKICAgICAgICAvLyBAdHMtaWdub3JlOiB3ZSdyZSBuZXZlciBpbnZva2luZyB0aGlzIHdpdGggU3ltYm9sIGFzIHNlY29uZCBhcmd1bWVudAogICAgICAgIHJldHVybiBuZXcgU29ja2V0UHJveHkoc29ja2V0LCByZWNlaXZlciwgcmVtb3RlLCBgJHtwYXRofToke3Byb3B9YCk7CiAgICAgIH0sCiAgICAgIGFwcGx5OiBhc3luYyAoXywgX18sIGFyZ3MpID0+IHsKICAgICAgICBpZiAoREVCVUcpCiAgICAgICAgICBjb25zb2xlLmxvZygKICAgICAgICAgICAgYFtTUGFwcGx5XSBzZW5kaW5nICR7dGhpcy5wYXRoLnN1YnN0cmluZygxKX0gcmVjZWl2ZXIgJHsKICAgICAgICAgICAgICB0aGlzW1JFQ0VJVkVSXQogICAgICAgICAgICB9IHRvICR7dGhpc1tSRU1PVEVdfWAsCiAgICAgICAgICApOwoKICAgICAgICBjb25zdCBkYXRhID0gYXdhaXQgdGhpcy5zb2NrZXQudXBncmFkZWQuc2VuZCgKICAgICAgICAgIHRoaXMucGF0aC5zdWJzdHJpbmcoMSksCiAgICAgICAgICBhcmdzLAogICAgICAgICAgdGhpc1tSRU1PVEVdID09PSBCUk9XU0VSID8gSW5maW5pdHkgOiB1bmRlZmluZWQsCiAgICAgICAgKTsKCiAgICAgICAgaWYgKGRhdGEgaW5zdGFuY2VvZiBSUENFcnJvcikgewogICAgICAgICAgY29uc3QgYXJnc3RyID0gWy4uLm5ldyBBcnJheShhcmdzLmxlbmd0aCldCiAgICAgICAgICAgIC5tYXAoKF8sIGkpID0+IFN0cmluZy5mcm9tQ2hhckNvZGUoOTcgKyBpKSkKICAgICAgICAgICAgLmpvaW4oYCxgKTsKCiAgICAgICAgICBpZiAoREVCVUcpCiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoCiAgICAgICAgICAgICAgYEVSUk9SIGNhbGxpbmcgW1ske2RhdGEub3JpZ2luTmFtZX1dXS4ke3RoaXMucGF0aAogICAgICAgICAgICAgICAgLnN1YnN0cmluZygxKQogICAgICAgICAgICAgICAgLnJlcGxhY2VBbGwoYDpgLCBgLmApfSgke2FyZ3N0cn0pOiAke2RhdGEubWVzc2FnZX1gLAogICAgICAgICAgICApOwoKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihkYXRhLm1lc3NhZ2UpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgIH0sCiAgICB9KTsKICB9Cn0KCi8qKgogKiBDcmVhdGUgYSBwcm94aWVkIHNvY2tldCB3aGVyZSB0aGUgY2FsbGVyIGxpdGVyYWxseSBkb2Vzbid0IG5lZWQKICogdG8gY2FyZSwgdGhleSBqdXN0IG5lZWQgdG8gY2FsbCBmdW5jdGlvbnMgYXMgaWYgdGhleSdyZSBsb2NhbHMuCiAqCiAqIEBwYXJhbSB7c3RyaW5nfSByZWNlaXZlciBUaGUgbmFtZSBvZiB0aGUgcmVjZWl2ZXIgZm9yIHRoaXMgc29ja2V0CiAqIEBwYXJhbSB7c3RyaW5nfSByZW1vdGUgVGhlIG5hbWUgb2YgdGhlIHJlbW90ZSBmb3IgdGhpcyBzb2NrZXQKICogQHBhcmFtIHsqfSBvcmlnaW4gVGhlIGNhbGxpbmcgb2JqZWN0LCB1c2VkIGZvciB0aGluZ3MgbGlrZSAiaWxsZWdhbCBmbmFtZXMiLCBzdGF0ZSBtYW5hZ2VtZW50LCBldGMuCiAqIEBwYXJhbSB7Kn0gc29ja2V0IFRoZSBzb2NrZXQgd2UncmUgd3JhcHBpbmcuCiAqIEByZXR1cm5zCiAqLwpleHBvcnQgZnVuY3Rpb24gcHJveHlTb2NrZXQocmVjZWl2ZXIsIHJlbW90ZSwgb3JpZ2luLCBzb2NrZXQpIHsKICBzb2NrZXQgPSBVcGdyYWRlZFNvY2tldC51cGdyYWRlKHNvY2tldCwgb3JpZ2luLCByZWNlaXZlciwgcmVtb3RlKTsKICByZXR1cm4gKHNvY2tldFtQUk9YWV0gPSBuZXcgU29ja2V0UHJveHkoc29ja2V0LCByZWNlaXZlciwgcmVtb3RlKSk7Cn0KCmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVCcm93c2VyQ2xpZW50KEJyb3dzZXJDbGllbnRDbGFzcykgewogICAgY29uc3Qgc29ja2V0ID0gbmV3IFdlYlNvY2tldCgKICAgICAgd2luZG93LmxvY2F0aW9uLnRvU3RyaW5nKCkucmVwbGFjZSgiaHR0cCIsICJ3cyIpCiAgICApOwogICAgY29uc3QgYnJvd3NlckNsaWVudCA9IG5ldyBCcm93c2VyQ2xpZW50Q2xhc3MoKTsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShicm93c2VyQ2xpZW50LCAic29ja2V0IiwgewogICAgICB2YWx1ZTogc29ja2V0LAogICAgICB3cml0YWJsZTogZmFsc2UsCiAgICAgIGNvbmZpZ3VyYWJsZTogZmFsc2UsCiAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgfSk7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoYnJvd3NlckNsaWVudCwgInNlcnZlciIsIHsKICAgICAgdmFsdWU6IHByb3h5U29ja2V0KCJicm93c2VyIiwgIndlYmNsaWVudCIsIGJyb3dzZXJDbGllbnQsIHNvY2tldCksCiAgICAgIHdyaXRhYmxlOiBmYWxzZSwKICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICB9KTsKICAgIGJyb3dzZXJDbGllbnQuc3RhdGUgPSB7fTsKICAgIGJyb3dzZXJDbGllbnQuaW5pdD8uKCk7CiAgICByZXR1cm4gYnJvd3NlckNsaWVudDsKICB9OwooZnVuY3Rpb24ocCxyKXsib2JqZWN0Ij09PXR5cGVvZiBleHBvcnRzJiYidW5kZWZpbmVkIiE9PXR5cGVvZiBtb2R1bGU/cihleHBvcnRzKToiZnVuY3Rpb24iPT09dHlwZW9mIGRlZmluZSYmZGVmaW5lLmFtZD9kZWZpbmUoWyJleHBvcnRzIl0scik6KHA9InVuZGVmaW5lZCIhPT10eXBlb2YgZ2xvYmFsVGhpcz9nbG9iYWxUaGlzOnB8fHNlbGYscihwLnJmYzY5MDI9e30pKX0pKHRoaXMsZnVuY3Rpb24ocCl7ZnVuY3Rpb24gcihhKXtyZXR1cm4gYS5yZXBsYWNlKC9+MS9nLCIvIikucmVwbGFjZSgvfjAvZywifiIpfWZ1bmN0aW9uIEUoYSl7cmV0dXJuIGEucmVwbGFjZSgvfi9nLCJ+MCIpLnJlcGxhY2UoL1wvL2csIn4xIil9ZnVuY3Rpb24geihhKXtyZXR1cm4gdm9pZCAwPT09YT8idW5kZWZpbmVkIjpudWxsPT09YT8ibnVsbCI6QXJyYXkuaXNBcnJheShhKT8iYXJyYXkiOnR5cGVvZiBhfWZ1bmN0aW9uIHYoYSl7aWYobnVsbD09YXx8Im9iamVjdCIhPXR5cGVvZiBhKXJldHVybiBhOwppZihhLmNvbnN0cnVjdG9yPT1BcnJheSl7dmFyIGI9YS5sZW5ndGgsYz1BcnJheShiKTtmb3IobGV0IGQ9MDtkPGI7ZCsrKWNbZF09dihhW2RdKTtyZXR1cm4gY31pZihhLmNvbnN0cnVjdG9yPT1EYXRlKXJldHVybiBuZXcgRGF0ZSgrYSk7Yj17fTtmb3IoYyBpbiBhKXcuY2FsbChhLGMpJiYoYltjXT12KGFbY10pKTtyZXR1cm4gYn1mdW5jdGlvbiBGKHtvcDphfSl7cmV0dXJuInJlbW92ZSI9PT1hfHwicmVwbGFjZSI9PT1hfHwiY29weSI9PT1hfHwibW92ZSI9PT1hfWZ1bmN0aW9uIEEoYSxiKXtjb25zdCBjPXt9O2Zvcihjb25zdCBkIGluIGEpdy5jYWxsKGEsZCkmJnZvaWQgMCE9PWFbZF0mJihjW2RdPTEpO2Zvcihjb25zdCBkIGluIGIpdy5jYWxsKGIsZCkmJnZvaWQgMCE9PWJbZF0mJmRlbGV0ZSBjW2RdO3JldHVybiBPYmplY3Qua2V5cyhjKX1mdW5jdGlvbiBHKGEpe2NvbnN0IGI9YS5sZW5ndGgsYz17fTtmb3IobGV0IGQ9MDtkPGI7ZCsrKXtjb25zdCBlPWFbZF07Zm9yKGNvbnN0IGYgaW4gZSl3LmNhbGwoZSwKZikmJnZvaWQgMCE9PWVbZl0mJihjW2ZdPShjW2ZdfHwwKSsxKX1mb3IoY29uc3QgZCBpbiBjKWNbZF08YiYmZGVsZXRlIGNbZF07cmV0dXJuIE9iamVjdC5rZXlzKGMpfWZ1bmN0aW9uIHgoYSxiKXtyZXR1cm57b3BlcmF0aW9uczphLm9wZXJhdGlvbnMuY29uY2F0KGIpLGNvc3Q6YS5jb3N0KzF9fWZ1bmN0aW9uIEgoYSxiLGMsZD1xKXtmdW5jdGlvbiBlKGssZyl7Y29uc3QgaD1gJHtrfSwke2d9YDt2YXIgbD1mW2hdO2lmKHZvaWQgMD09PWwpe2lmKDA8ayYmMDxnJiYhZChhW2stMV0sYltnLTFdLGMuYWRkKFN0cmluZyhrLTEpKSkubGVuZ3RoKWw9ZShrLTEsZy0xKTtlbHNle2w9W107aWYoMDxrKXt2YXIgdD1lKGstMSxnKTtsLnB1c2goeCh0LHtvcDoicmVtb3ZlIixpbmRleDprLTF9KSl9MDxnJiYodD1lKGssZy0xKSxsLnB1c2goeCh0LHtvcDoiYWRkIixpbmRleDprLTEsdmFsdWU6YltnLTFdfSkpKTswPGsmJjA8ZyYmKHQ9ZShrLTEsZy0xKSxsLnB1c2goeCh0LHtvcDoicmVwbGFjZSIsCmluZGV4OmstMSxvcmlnaW5hbDphW2stMV0sdmFsdWU6YltnLTFdfSkpKTtsPWwuc29ydCgoSSxKKT0+SS5jb3N0LUouY29zdClbMF19ZltoXT1sfXJldHVybiBsfWNvbnN0IGY9eyIwLDAiOntvcGVyYXRpb25zOltdLGNvc3Q6MH19LEI9aXNOYU4oYS5sZW5ndGgpfHwwPj1hLmxlbmd0aD8wOmEubGVuZ3RoO3ZhciB1PWlzTmFOKGIubGVuZ3RoKXx8MD49Yi5sZW5ndGg/MDpiLmxlbmd0aDt1PWUoQix1KS5vcGVyYXRpb25zO1t1XT11LnJlZHVjZSgoW2ssZ10saCk9PntpZigiYWRkIj09PWgub3Ape3ZhciBsPWguaW5kZXgrMStnO2g9e29wOmgub3AscGF0aDpjLmFkZChsPEIrZz9TdHJpbmcobCk6Ii0iKS50b1N0cmluZygpLHZhbHVlOmgudmFsdWV9O3JldHVybltrLmNvbmNhdChoKSxnKzFdfWlmKCJyZW1vdmUiPT09aC5vcClyZXR1cm4gaD17b3A6aC5vcCxwYXRoOmMuYWRkKFN0cmluZyhoLmluZGV4K2cpKS50b1N0cmluZygpfSxbay5jb25jYXQoaCksZy0xXTtsPWMuYWRkKFN0cmluZyhoLmluZGV4KwpnKSk7aD1kKGgub3JpZ2luYWwsaC52YWx1ZSxsKTtyZXR1cm5bay5jb25jYXQoLi4uaCksZ119LFtbXSwwXSk7cmV0dXJuIHV9ZnVuY3Rpb24gSyhhLGIsYyxkPXEpe2NvbnN0IGU9W107QShhLGIpLmZvckVhY2goZj0+e2UucHVzaCh7b3A6InJlbW92ZSIscGF0aDpjLmFkZChmKS50b1N0cmluZygpfSl9KTtBKGIsYSkuZm9yRWFjaChmPT57ZS5wdXNoKHtvcDoiYWRkIixwYXRoOmMuYWRkKGYpLnRvU3RyaW5nKCksdmFsdWU6YltmXX0pfSk7RyhbYSxiXSkuZm9yRWFjaChmPT57ZS5wdXNoKC4uLmQoYVtmXSxiW2ZdLGMuYWRkKGYpKSl9KTtyZXR1cm4gZX1mdW5jdGlvbiBxKGEsYixjLGQ9cSl7aWYoYT09PWIpcmV0dXJuW107Y29uc3QgZT16KGEpLGY9eihiKTtyZXR1cm4iYXJyYXkiPT1lJiYiYXJyYXkiPT1mP0goYSxiLGMsZCk6Im9iamVjdCI9PWUmJiJvYmplY3QiPT1mP0soYSxiLGMsZCk6W3tvcDoicmVwbGFjZSIscGF0aDpjLnRvU3RyaW5nKCksdmFsdWU6Yn1dfWZ1bmN0aW9uIHkoYSwKYixjKXtBcnJheS5pc0FycmF5KGEpPyItIj09Yj9hLnB1c2goYyk6KGI9cGFyc2VJbnQoYiwxMCksYS5zcGxpY2UoYiwwLGMpKTphW2JdPWN9ZnVuY3Rpb24gQyhhLGIpe0FycmF5LmlzQXJyYXkoYSk/KGI9cGFyc2VJbnQoYiwxMCksYS5zcGxpY2UoYiwxKSk6ZGVsZXRlIGFbYl19ZnVuY3Rpb24gTChhLGIpe2E9bS5mcm9tSlNPTihiLnBhdGgpLmV2YWx1YXRlKGEpO2lmKG51bGw9PT1hLnBhcmVudClyZXR1cm4gbmV3IG4oYi5wYXRoKTtpZihBcnJheS5pc0FycmF5KGEucGFyZW50KSl7aWYocGFyc2VJbnQoYS5rZXksMTApPj1hLnBhcmVudC5sZW5ndGgpcmV0dXJuIG5ldyBuKGIucGF0aCl9ZWxzZSBpZih2b2lkIDA9PT1hLnZhbHVlKXJldHVybiBuZXcgbihiLnBhdGgpO2EucGFyZW50W2Eua2V5XT1iLnZhbHVlO3JldHVybiBudWxsfWZ1bmN0aW9uIE0oYSxiKXtzd2l0Y2goYi5vcCl7Y2FzZSAiYWRkIjpyZXR1cm4gYT1tLmZyb21KU09OKGIucGF0aCkuZXZhbHVhdGUoYSksdm9pZCAwPT09CmEucGFyZW50P2I9bmV3IG4oYi5wYXRoKTooeShhLnBhcmVudCxhLmtleSx2KGIudmFsdWUpKSxiPW51bGwpLGI7Y2FzZSAicmVtb3ZlIjpyZXR1cm4gYT1tLmZyb21KU09OKGIucGF0aCkuZXZhbHVhdGUoYSksdm9pZCAwPT09YS52YWx1ZT9iPW5ldyBuKGIucGF0aCk6KEMoYS5wYXJlbnQsYS5rZXkpLGI9bnVsbCksYjtjYXNlICJyZXBsYWNlIjpyZXR1cm4gTChhLGIpO2Nhc2UgIm1vdmUiOnZhciBjPW0uZnJvbUpTT04oYi5mcm9tKS5ldmFsdWF0ZShhKTt2b2lkIDA9PT1jLnZhbHVlP2I9bmV3IG4oYi5mcm9tKTooYT1tLmZyb21KU09OKGIucGF0aCkuZXZhbHVhdGUoYSksdm9pZCAwPT09YS5wYXJlbnQ/Yj1uZXcgbihiLnBhdGgpOihDKGMucGFyZW50LGMua2V5KSx5KGEucGFyZW50LGEua2V5LGMudmFsdWUpLGI9bnVsbCkpO3JldHVybiBiO2Nhc2UgImNvcHkiOnJldHVybiBjPW0uZnJvbUpTT04oYi5mcm9tKS5ldmFsdWF0ZShhKSx2b2lkIDA9PT1jLnZhbHVlP2I9bmV3IG4oYi5mcm9tKToKKGE9bS5mcm9tSlNPTihiLnBhdGgpLmV2YWx1YXRlKGEpLHZvaWQgMD09PWEucGFyZW50P2I9bmV3IG4oYi5wYXRoKTooeShhLnBhcmVudCxhLmtleSx2KGMudmFsdWUpKSxiPW51bGwpKSxiO2Nhc2UgInRlc3QiOnJldHVybiBhPW0uZnJvbUpTT04oYi5wYXRoKS5ldmFsdWF0ZShhKSxiPXEoYS52YWx1ZSxiLnZhbHVlLG5ldyBtKS5sZW5ndGg/bmV3IE4oYS52YWx1ZSxiLnZhbHVlKTpudWxsLGJ9cmV0dXJuIG5ldyBPKGIpfWZ1bmN0aW9uIFAoYSl7ZnVuY3Rpb24gYihjLGQsZSl7Y29uc3QgZj1hKGMsZCxlKTtyZXR1cm4gQXJyYXkuaXNBcnJheShmKT9mOnEoYyxkLGUsYil9cmV0dXJuIGJ9ZnVuY3Rpb24gRChhLGIpe2E9bS5mcm9tSlNPTihiKS5ldmFsdWF0ZShhKTtpZih2b2lkIDAhPT1hKXJldHVybntvcDoidGVzdCIscGF0aDpiLHZhbHVlOmEudmFsdWV9fWNsYXNzIG17Y29uc3RydWN0b3IoYT1bIiJdKXt0aGlzLnRva2Vucz1hfXN0YXRpYyBmcm9tSlNPTihhKXtjb25zdCBiPQphLnNwbGl0KCIvIikubWFwKHIpO2lmKCIiIT09YlswXSl0aHJvdyBFcnJvcihgSW52YWxpZCBKU09OIFBvaW50ZXI6ICR7YX1gKTtyZXR1cm4gbmV3IG0oYil9dG9TdHJpbmcoKXtyZXR1cm4gdGhpcy50b2tlbnMubWFwKEUpLmpvaW4oIi8iKX1ldmFsdWF0ZShhKXtsZXQgYj1udWxsLGM9IiI7Zm9yKGxldCBkPTEsZT10aGlzLnRva2Vucy5sZW5ndGg7ZDxlO2QrKyliPWEsYz10aGlzLnRva2Vuc1tkXSwiX19wcm90b19fIiE9YyYmImNvbnN0cnVjdG9yIiE9YyYmInByb3RvdHlwZSIhPWMmJihhPShifHx7fSlbY10pO3JldHVybntwYXJlbnQ6YixrZXk6Yyx2YWx1ZTphfX1nZXQoYSl7cmV0dXJuIHRoaXMuZXZhbHVhdGUoYSkudmFsdWV9c2V0KGEsYil7Zm9yKGxldCBjPTEsZD10aGlzLnRva2Vucy5sZW5ndGgtMSxlPXRoaXMudG9rZW5zW2NdO2M8ZDtjKyspYT0oYXx8e30pW2VdO2EmJihhW3RoaXMudG9rZW5zW3RoaXMudG9rZW5zLmxlbmd0aC0xXV09Yil9cHVzaChhKXt0aGlzLnRva2Vucy5wdXNoKGEpfWFkZChhKXthPQp0aGlzLnRva2Vucy5jb25jYXQoU3RyaW5nKGEpKTtyZXR1cm4gbmV3IG0oYSl9fWNvbnN0IHc9T2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTtjbGFzcyBuIGV4dGVuZHMgRXJyb3J7Y29uc3RydWN0b3IoYSl7c3VwZXIoYFZhbHVlIHJlcXVpcmVkIGF0IHBhdGg6ICR7YX1gKTt0aGlzLnBhdGg9YTt0aGlzLm5hbWU9Ik1pc3NpbmdFcnJvciJ9fWNsYXNzIE4gZXh0ZW5kcyBFcnJvcntjb25zdHJ1Y3RvcihhLGIpe3N1cGVyKGBUZXN0IGZhaWxlZDogJHthfSAhPSAke2J9YCk7dGhpcy5hY3R1YWw9YTt0aGlzLmV4cGVjdGVkPWI7dGhpcy5uYW1lPSJUZXN0RXJyb3IifX1jbGFzcyBPIGV4dGVuZHMgRXJyb3J7Y29uc3RydWN0b3IoYSl7c3VwZXIoYEludmFsaWQgb3BlcmF0aW9uOiAke2Eub3B9YCk7dGhpcy5vcGVyYXRpb249YTt0aGlzLm5hbWU9IkludmFsaWRPcGVyYXRpb25FcnJvciJ9fXAuYXBwbHlQYXRjaD1mdW5jdGlvbihhLGIpe3JldHVybiBiLm1hcChjPT5NKGEsYykpfTsKcC5jcmVhdGVQYXRjaD1mdW5jdGlvbihhLGIsYyl7Y29uc3QgZD1uZXcgbTtyZXR1cm4oYz9QKGMpOnEpKGEsYixkKX07cC5jcmVhdGVUZXN0cz1mdW5jdGlvbihhLGIpe2NvbnN0IGM9W107Yi5maWx0ZXIoRikuZm9yRWFjaChkPT57Y29uc3QgZT1EKGEsZC5wYXRoKTtlJiZjLnB1c2goZSk7ImZyb20iaW4gZCYmKGQ9RChhLGQuZnJvbSkpJiZjLnB1c2goZCl9KTtyZXR1cm4gY307T2JqZWN0LmRlZmluZVByb3BlcnR5KHAsIl9fZXNNb2R1bGUiLHt2YWx1ZTohMH0pfSk7Cg==");var _={".html":"text/html",".css":"text/css",".js":"application/javascript",".jpg":"image/jpeg",".png":"image/png"},eg="text/plain";function $(C){let I=Object.keys(_).find(c=>C.slice(-c.length)===c);return _[I]||eg}function tg(C,I){return C==="/"?D(I,"index.html"):(C=C.substring(1),C=C.replaceAll("../","/").replace(/\/+/g,"/"),C=D(I,C),C)}function Zg(C,I){console.error(`Can't serve ${C}, so it probably doesn't exist`),I.writeHead(404,{"Content-Type":"text/html"}),I.end("<doctype html><html><body>resource not found</body></html>")}function q(C,I){return async(g,c)=>{if(g.url.includes("?")){let[Z,e]=g.url.split(/\\?\?/);g.url=Z,g.params=new URLSearchParams(e)}let l=g.url;if(l==="/favicon.ico")return c.writeHead(200,{"Content-Type":"text/plain"}),c.end("","utf-8");if(l==="/socketless.js")return c.writeHead(200,{"Content-Type":$(".js")}),c.end(M,"utf-8");if(!await I.handle(l,g,c)){var n=tg(g.url,C);ig.readFile(n,(Z,e)=>{if(Z)return Zg(n,c);c.writeHead(200,{"Content-Type":$(n)}),c.end(e,"utf-8")})}}}var dg=!0,fg=!0;function Ug(C,I){C=x(C),I=E(I);let g=O(C),c={createServer:function(n){let Z,e;n?.constructor===Object?e=n:Z=n;let o=Z;if(!o){let s=new J(null),t=(m,B)=>{if(m.url.includes("?")){let[a,h]=m.url.split(/\\?\?/);m.url=a,m.params=new URLSearchParams(h)}s.handle(m.url,m,B)};o=e?Ig.createServer(e,t):gg.createServer(t),o.addRoute=s.addRouteHandler.bind(s),o.removeRoute=s.removeRoute.bind(s)}let i=new cg({noServer:!0});o.on("upgrade",(s,t,m)=>{i.handleUpgrade(s,t,m,B=>{i.emit("connection",B,s)})});let G=new I(i,o);return i.on("connection",function(s){G.connectClientSocket(s)}),o},createClient:function(n,Z,e=C){n=n.replace("http","ws");let o=new sg(n,{rejectUnauthorized:!Z}),i=new e;o.on("close",(...s)=>i.onDisconnect(...s));function G(s){try{let{name:t,payload:m}=JSON.parse(s);t==="handshake:setid"&&(o.off("message",G),i.setState(m),i.connectServerSocket(o))}catch{}}return o.on("message",G),i},createWebClient:function(n,Z,e,o){let i=c.createClient(n,o,g),G=new J(i),s=q(Z,G),t=e?Ig.createServer(e,s):gg.createServer(s),m=new cg({noServer:!0});return t.on("upgrade",(B,a,h)=>{m.handleUpgrade(B,a,h,W=>{m.emit("connection",W,B)})}),i.ws=m,i.webserver=t,m.on("connection",B=>{i.connectBrowserSocket(B),B.on("message",async a=>{a=a.toString();let{name:h,payload:W,error:V}=JSON.parse(a);if(V)throw new Error(V);let S=H(h);if(h==="syncState"){let d=await i.syncState();return B.send(JSON.stringify({name:S,payload:d}))}if(h==="disconnect")return i.disconnect();if(h.endsWith(w))i.browser.socket.router(a,dg);else{let d=i.server,Y=h.split(":");for(;Y.length;)d=d[Y.shift()];let u=await d(...W);B.send(JSON.stringify({name:S,payload:u}))}}),B.on("close",()=>{i.disconnectBrowserSocket()})}),t.addRoute=G.addRouteHandler.bind(G),t.removeRoute=G.removeRoute.bind(G),{client:i,clientWebServer:t}}};return c}export{fg as ALLOW_SELF_SIGNED_CERTS,Ug as linkClasses};
